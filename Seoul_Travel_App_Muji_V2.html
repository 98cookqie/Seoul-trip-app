<!DOCTYPE html>
 <html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>首爾冬日旅 | Seoul Trip</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Google Fonts: Noto Sans (UI) & Noto Serif (Headers) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for Wallet Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuration for Tailwind to match Muji Style -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#fdfcf8',       /* 溫暖的米白紙張色 */
                            card: '#ffffff',     /* 純白卡片 */
                            text: '#44403c',     /* 深灰 Stone-700 */
                            sub: '#78716c',      /* 淺灰 Stone-500 */
                            accent: '#a8a29e',   /* 裝飾灰 Stone-400 */
                            primary: '#57534e',  /* 主按鈕 Stone-600 */
                            highlight: '#d97706' /* 重點提醒 Amber-600 (柔和橘) */
                        },
                        attraction: '#34d399', // Emerald Green
                        restaurant: '#f87171', // Red
                        shopping: '#60a5fa',   // Blue
                        transport: '#a78bfa'  // Violet
                    }
                },
                fontFamily: {
                    sans: ['"Noto Sans TC"', 'sans-serif'],
                    serif: ['"Noto Serif TC"', 'serif'],
                }
            }
        }
    </script>

    <style>
        /* 全局設定 */
        body {
            background-color: #fdfcf8;
            color: #44403c;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 隱藏 Scrollbar 但保持功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 頁面切換動畫 */
        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            padding-bottom: 80px; /* 避開底部導航 */
        }
        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal 樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            display: block;
            opacity: 1;
        }
        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 85%;
            background: #fdfcf8;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Checklist Input Ghost Style */
        .input-ghost {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .muji-checkbox:checked {
            background-color: #57534e;
            border-color: #57534e;
        }

        /* --- 升級版開場動畫 (Intro) --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #fdfcf8;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* 3秒動畫結束後淡出隱藏 */
            animation: hideIntro 0.5s ease-out 3s forwards;
            pointer-events: none; /* 避免擋住點擊 */
        }

        #intro-text {
            font-family: 'Noto Serif TC', serif;
            font-size: 5rem;
            font-weight: 700;
            color: #44403c;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            white-space: nowrap;
            
            /* 縮放中心點設定在 'S' 的位置 (大約左側 12% 處) */
            transform-origin: 12% 55%; 
            
            /* 3秒縮放動畫 */
            animation: zoomThrough 3s cubic-bezier(0.7, 0, 0.2, 1) forwards;
        }

        /* 針對 'S' 的特別樣式 */
        .intro-s {
            display: inline-block;
            background-clip: text;
            -webkit-background-clip: text;
            color: #44403c; /* 初始顏色 */
            
            /* S 的變色動畫 */
            animation: colorMorph 3s ease-in-out forwards;
        }

        /* 縮放並穿過文字的動畫 */
        @keyframes zoomThrough {
            0% {
                opacity: 0;
                transform: scale(0.5); /* 初始略小 */
            }
            15% {
                opacity: 1;
                transform: scale(1); /* 正常大小停留一下 */
            }
            40% {
                transform: scale(2); /* 開始放大 */
            }
            100% {
                opacity: 0; /* 最後淡出 */
                transform: scale(150); /* 巨大縮放，模擬穿過 */
            }
        }

        /* S 變成彩色的動畫 */
        @keyframes colorMorph {
            0%, 20% {
                color: #44403c; /* 保持深灰 */
            }
            40% {
                color: transparent;
                background-image: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); /* 粉彩漸層 */
            }
            100% {
                color: transparent;
                background-image: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); /* 變為夢幻紫粉 */
            }
        }

        /* 隱藏遮罩層 */
        @keyframes hideIntro {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
    </style>
</head>
<body class="font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- INTRO ANIMATION -->
    <div id="intro-overlay">
        <!-- 將 S 用 span 包起來以獨立變色 -->
        <h1 id="intro-text"><span class="intro-s">S</span>EOUL</h1>
    </div>

    <!-- Header -->
    <header class="bg-muji-bg px-6 pt-12 pb-4 sticky top-0 z-10 border-b border-stone-200/50">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="font-serif text-3xl text-stone-800 tracking-wide font-bold">SEOUL</h1>
                <p class="text-sm text-muji-sub mt-1 tracking-widest uppercase">Dec 18 - Dec 21, 2024</p>
            </div>
            <div class="text-right flex flex-col justify-end">
                <div class="text-2xl font-bold text-stone-800 flex items-center justify-end">
                     <i class="fa-solid fa-snowflake text-blue-300 text-lg mr-2"></i>
                     <span class="text-sm text-stone-400">-6°C</span>
                </div>
                <p class="text-xs text-muji-sub mt-1">Cold Winter</p>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative px-0" id="main-container">

        <!-- ================= SECTION 1: PLAN (行程) ================= -->
        <div id="section-plan" class="page-section active">
            <!-- Day Tabs -->
            <div class="flex overflow-x-auto no-scrollbar px-6 py-4 gap-3 sticky top-0 bg-muji-bg/95 backdrop-blur-sm z-10" id="day-tabs">
                <!-- Javascript will render tabs here -->
            </div>

            <!-- Itinerary Content -->
            <div id="itinerary-content" class="px-6 pb-8 space-y-4">
                <!-- Javascript will render cards here -->
            </div>
        </div>

        <!-- ================= SECTION 2: WALLET (記帳) ================= -->
        <div id="section-wallet" class="page-section">
            <div class="bg-stone-100 p-6 pb-8 rounded-b-3xl shadow-inner mb-6">
                <!-- Rate Setting -->
                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-bold text-muji-sub uppercase tracking-wider">Exchange Rate (KRW to TWD)</label>
                    <div class="flex items-center bg-white rounded-lg px-2 py-1 shadow-sm">
                        <span class="text-xs text-stone-400 mr-2">1 TWD ≈</span>
                        <input type="number" id="exchange-rate" value="42.5" class="w-12 text-right text-sm font-bold text-stone-700 outline-none bg-transparent" onchange="updateRate()">
                        <span class="text-xs text-stone-400 ml-1">KRW</span>
                    </div>
                </div>

                <!-- Calculator -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-stone-200">
                    <div class="flex flex-col">
                        <label class="text-xs text-muji-sub mb-1">快速換算 (支援 + - * /)</label>
                        <div class="flex items-end gap-2">
                            <input type="text" id="calc-input" placeholder="例如: 5000+2500" class="flex-1 text-xl font-mono text-stone-800 border-b border-stone-200 focus:border-muji-primary outline-none py-1 bg-transparent">
                            <span class="text-stone-400 text-xl">=</span>
                            <div class="text-right">
                                <div id="calc-result-krw" class="text-sm text-stone-500">0 ₩</div>
                                <div id="calc-result-twd" class="text-2xl font-bold text-muji-highlight">0 NT$</div>
                            </div>
                        </div>
                    </div>
                    <!-- Quick Add Button -->
                    <button onclick="copyCalcToExpense()" class="w-full mt-3 bg-stone-100 text-stone-600 text-xs py-2 rounded-lg hover:bg-stone-200 transition">
                        <i class="fa-solid fa-arrow-down mr-1"></i> 把計算結果加入記帳
                    </button>
                </div>
            </div>

            <!-- Expense Form -->
            <div class="px-6 mb-8">
                <h3 class="font-serif text-lg mb-4">新增消費</h3>
                <div class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <input type="text" id="expense-name" placeholder="品項 (如: 烤肉)" class="flex-[2] bg-white border border-stone-200 rounded-lg px-3 py-3 text-sm outline-none focus:border-muji-primary">
                        <select id="expense-payer" class="flex-[1] bg-white border border-stone-200 rounded-lg px-2 py-3 text-sm outline-none focus:border-muji-primary text-stone-700">
                            <option value="Kathy">Kathy</option>
                            <option value="Nick">Nick</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="expense-amount" placeholder="₩ 韓幣金額" class="flex-[2] bg-white border border-stone-200 rounded-lg px-3 py-3 text-sm outline-none focus:border-muji-primary">
                        <select id="expense-category" class="flex-[1] bg-white border border-stone-200 rounded-lg px-2 py-3 text-sm outline-none focus:border-muji-primary text-stone-700">
                            <option value="food">食</option>
                            <option value="transport">交通</option>
                            <option value="stay">住宿</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-muji-primary text-white py-3 rounded-lg shadow-md active:scale-95 transition text-sm font-medium tracking-wide">
                        記帳
                    </button>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="px-6 mb-4 flex justify-center">
                <div class="bg-stone-100 p-1 rounded-lg inline-flex">
                    <button onclick="toggleWalletView('list')" id="btn-view-list" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-stone-800 shadow-sm transition-all">列表</button>
                    <button onclick="toggleWalletView('chart')" id="btn-view-chart" class="px-4 py-1.5 rounded-md text-xs font-bold text-stone-500 hover:text-stone-800 transition-all">圖表分析</button>
                </div>
            </div>

            <!-- Expense List & Summary (Default View) -->
            <div id="wallet-view-list" class="px-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center">
                        <span class="block text-xs text-stone-400 mb-1">Kathy Paid</span>
                        <span id="total-kathy" class="font-bold text-stone-700">NT$ 0</span>
                    </div>
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center">
                        <span class="block text-xs text-stone-400 mb-1">Nick Paid</span>
                        <span id="total-nick" class="font-bold text-stone-700">NT$ 0</span>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4 border-b border-stone-200 pb-2">
                    <h3 class="font-serif text-lg">消費紀錄</h3>
                    <div class="text-right">
                        <span class="text-xs text-muji-sub block">總支出 (Total)</span>
                        <span id="total-twd" class="font-bold text-muji-text">NT$ 0</span>
                    </div>
                </div>
                <ul id="expense-list" class="space-y-3 pb-20">
                    <!-- Javascript will render list here -->
                </ul>
            </div>

            <!-- Chart View (Hidden by default) -->
            <div id="wallet-view-chart" class="px-6 hidden pb-20">
                <div class="bg-white p-4 rounded-xl border border-stone-100 shadow-sm">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div class="mt-6 space-y-3" id="category-summary-list">
                    <!-- Category breakdown text will go here -->
                </div>
            </div>
        </div>

        <!-- ================= SECTION 3: LISTS (清單) ================= -->
        <div id="section-lists" class="page-section">
            <div class="px-6 py-4 space-y-8">
                
                <!-- Checklist -->
                <div>
                    <h3 class="font-serif text-xl mb-4 border-l-4 border-muji-primary pl-3">行前準備</h3>
                    <p class="text-xs text-stone-400 mb-2">點擊文字可修改，下方輸入框可新增。</p>
                    <div id="checklist-container" class="space-y-3">
                        <!-- JS Render -->
                    </div>
                    <!-- Add New Item Input -->
                    <div class="mt-3 flex items-center space-x-3 bg-stone-50 p-3 rounded-lg border border-dashed border-stone-300">
                        <i class="fa-solid fa-plus text-stone-400 ml-1"></i>
                        <input type="text" id="new-checklist-item" placeholder="新增項目..." 
                               class="bg-transparent text-sm outline-none text-stone-600 w-full placeholder-stone-400"
                               onkeydown="if(event.key === 'Enter') addChecklistItem()">
                    </div>
                </div>

                <!-- Memo -->
                <div>
                    <h3 class="font-serif text-xl mb-4 border-l-4 border-stone-300 pl-3">個人備忘錄</h3>
                    <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden relative group">
                        <textarea id="memo-area" class="w-full h-48 p-4 text-sm leading-relaxed text-stone-700 outline-none resize-none bg-yellow-50/20" placeholder="在此輸入筆記，網址會自動轉換為連結..."></textarea>
                        <div class="absolute bottom-2 right-2 text-xs text-stone-300">Auto-saving</div>
                    </div>
                    <!-- Link Preview Area -->
                    <div id="memo-links" class="mt-4 flex flex-wrap gap-2">
                        <!-- Extracted Links appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= SECTION 4: INFO (資訊) ================= -->
        <div id="section-info" class="page-section">
            <div class="px-6 py-4 space-y-6">

                <!-- 1. Flight Info (Top) -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <h3 class="text-sm font-bold text-stone-400 mb-3 tracking-wider uppercase">Flights 飛機航班時間</h3>
                    <div class="mb-4 pb-4 border-b border-stone-100">
                        <div class="flex justify-between text-lg font-bold text-stone-800">
                            <span>HUN</span> <i class="fa-solid fa-plane text-xs text-stone-300 self-center"></i> <span>ICN</span>
                        </div>
                        <div class="flex justify-between text-sm text-muji-sub mt-1">
                            <span>12/18 14:45</span> <span>RF5203</span> <span>18:15</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-lg font-bold text-stone-800">
                            <span>ICN</span> <i class="fa-solid fa-plane text-xs text-stone-300 self-center"></i> <span>HUN</span>
                        </div>
                        <div class="flex justify-between text-sm text-muji-sub mt-1">
                            <span>12/21 11:50</span> <span>RF5193</span> <span>13:30</span>
                        </div>
                    </div>
                </div>
                
                <!-- 2. Weather Widget -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-stone-400 tracking-wider uppercase">Seoul Weather 首爾天氣</h3>
                        <span class="text-[10px] text-stone-300">Source: KMA</span>
                    </div>
                    <!-- Horizontal Scroll for Weekly Forecast -->
                    <div class="flex overflow-x-auto no-scrollbar gap-4 pb-2">
                        <!-- Day 18 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/18</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-6°C</span>
                            <span class="text-[10px] text-stone-400">晴朗</span>
                        </div>
                        <!-- Day 19 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/19</span>
                            <i class="fa-solid fa-cloud-sun text-2xl text-stone-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-4°C</span>
                            <span class="text-[10px] text-stone-400">多雲</span>
                        </div>
                        <!-- Day 20 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/20</span>
                            <i class="fa-solid fa-snowflake text-2xl text-blue-200 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-5°C</span>
                            <span class="text-[10px] text-stone-400">小雪</span>
                        </div>
                        <!-- Day 21 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/21</span>
                            <i class="fa-solid fa-cloud text-2xl text-stone-300 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-2°C</span>
                            <span class="text-[10px] text-stone-400">陰天</span>
                        </div>
                        <!-- Day 22 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-70">
                            <span class="text-xs text-stone-500 mb-1">12/22</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-3°C</span>
                            <span class="text-[10px] text-stone-400">晴朗</span>
                        </div>
                        <!-- Day 23 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-70">
                            <span class="text-xs text-stone-500 mb-1">12/23</span>
                            <i class="fa-solid fa-cloud-sun text-2xl text-stone-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-1°C</span>
                            <span class="text-[10px] text-stone-400">多雲</span>
                        </div>
                        <!-- Day 24 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-50">
                            <span class="text-xs text-stone-500 mb-1">12/24</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">0°C</span>
                            <span class="text-[10px] text-stone-400">平安夜</span>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Accommodation -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-stone-100 rounded-bl-full -mr-8 -mt-8"></div>
                    <h3 class="text-sm font-bold text-stone-400 mb-2 tracking-wider uppercase">Accommodation 住宿資訊</h3>
                    <h2 class="text-xl font-serif text-stone-800 mb-1">Seoul N Hostel</h2>
                    <p class="text-xs text-stone-500 mb-4 w-3/4">159-16 Mareunnae-ro, Jung District, Seoul</p>
                    <a href="https://maps.app.goo.gl/xuu6swMwXezqVpUk6" target="_blank" class="inline-block bg-stone-800 text-white text-xs px-4 py-2 rounded-full shadow-md">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> 導航
                    </a>
                </div>

                <!-- 4. Electronic Arrival Card (K-ETA / Q-Code) - NEW SECTION -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <h3 class="text-sm font-bold text-stone-400 mb-3 tracking-wider uppercase">Arrival Card 電子入境卡</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Image 1 Placeholder -->
                        <div class="border border-stone-200 rounded-lg p-2 bg-stone-50 text-center">
                            <div class="aspect-[3/4] bg-stone-200 rounded flex items-center justify-center mb-2 overflow-hidden">
                                <!-- Replace src with actual path if files are local, e.g. "IMG_2066.jpg" -->
                                <img src="IMG_2066.jpg" alt="電子入境卡截圖 1" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x400/e5e5e5/a3a3a3?text=IMG_2066.jpg';">
                            </div>
                            <span class="text-xs text-stone-500">IMG_2066.jpg</span>
                        </div>
                        <!-- Image 2 Placeholder -->
                        <div class="border border-stone-200 rounded-lg p-2 bg-stone-50 text-center">
                            <div class="aspect-[3/4] bg-stone-200 rounded flex items-center justify-center mb-2 overflow-hidden">
                                <!-- Replace src with actual path if files are local, e.g. "IMG_2067.jpg" -->
                                <img src="IMG_2067.jpg" alt="電子入境卡截圖 2" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x400/e5e5e5/a3a3a3?text=IMG_2067.jpg';">
                            </div>
                            <span class="text-xs text-stone-500">IMG_2067.jpg</span>
                        </div>
                    </div>
                </div>

                <!-- 5. Emergency Info -->
                <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                    <h3 class="text-red-800 font-bold mb-3 flex items-center">
                        <i class="fa-solid fa-kit-medical mr-2"></i> 緊急聯絡 (僅供查閱)
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-red-100 pb-2">
                            <span class="text-sm text-stone-600">警察 / 救護車</span>
                            <span class="font-mono text-lg font-bold text-red-600">112 / 119</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-red-100 pb-2">
                            <span class="text-sm text-stone-600">外交部緊急聯絡</span>
                            <span class="font-mono text-sm font-bold text-stone-700">+82-10-9093-5009</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-stone-600">Seoul N Hostel 旅館電話</span>
                            <span class="font-mono text-sm font-bold text-stone-700">070-8152-8160</span>
                        </div>
                    </div>
                </div>

                <!-- 6. Tips (Bottom) -->
                <div class="bg-stone-800 text-stone-300 p-5 rounded-xl">
                    <h3 class="text-white font-serif mb-3"><i class="fa-solid fa-triangle-exclamation mr-2 text-amber-500"></i>注意事項 & 禁忌</h3>
                    <ul class="text-sm space-y-2 list-disc list-inside">
                        <li><strong class="text-white">違禁品：</strong>肉類製品(含肉乾、香腸)嚴禁攜帶入境，違者重罰。新鮮水果亦不可入境。</li>
                        <li><strong class="text-white">電壓：</strong>220V，兩孔圓形插座 (需轉接頭)。</li>
                        <li><strong class="text-white">禮儀：</strong>搭乘地鐵請勿坐博愛座。餐廳小菜可免費續加，但請以此為限，勿浪費。</li>
                        <li><strong class="text-white">交通：</strong>Google Maps 僅供查詢大眾運輸，步行導航建議使用 NAVER Map。</li>
                    </ul>
                </div>
                
                <div class="text-center pt-8">
                    <button onclick="resetApp()" class="text-xs text-stone-300 underline">重置所有資料 (Reset)</button>
                </div>
            </div>
        </div>

    </main>
    
    <!-- DETAIL MODAL (Pop-up) -->
    <div id="detail-modal-overlay" class="modal-overlay" onclick="closeDetailModal(event)">
        <div id="detail-modal-content" class="modal-content" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-muji-bg px-6 py-4 border-b border-stone-200 flex justify-between items-center z-20">
                <h2 id="modal-title" class="font-serif text-2xl text-stone-800 truncate pr-4"></h2>
                <button onclick="closeDetailModal()" class="text-stone-400 hover:text-stone-800 transition">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div id="modal-body" class="p-6 space-y-6 pb-12">
                <!-- Content will be injected here by JS -->
                
                <!-- Time Label -->
                <div class="flex items-center gap-2">
                    <span class="bg-stone-200 text-stone-700 px-3 py-1 rounded-full text-xs font-mono font-bold" id="modal-time"></span>
                </div>
                
                <!-- Story Section -->
                <div id="modal-section-story">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-stone-400 pl-2">景點故事</h3>
                    <p id="modal-story" class="text-sm text-stone-600 leading-relaxed text-justify"></p>
                </div>

                <!-- Guide Section -->
                <div id="modal-section-guide">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-stone-400 pl-2">旅遊攻略</h3>
                    <p id="modal-guide" class="text-sm text-stone-600 leading-relaxed text-justify"></p>
                </div>
                
                <!-- Tips Section -->
                <div id="modal-tips-container">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-muji-highlight pl-2">重點提醒</h3>
                    <div id="modal-tips" class="space-y-3">
                        <!-- Tips injected here -->
                    </div>
                </div>

                <!-- Map Button -->
                <div class="pt-4 border-t border-stone-100">
                    <a id="modal-map-link" href="#" target="_blank" class="block w-full text-center bg-stone-800 text-white py-3 rounded-lg shadow-md active:scale-95 transition text-sm font-medium tracking-wide">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> 在地圖上查看
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-stone-200 px-6 py-2 pb-5 flex justify-between items-center fixed bottom-0 w-full z-50 text-xs font-medium text-stone-400 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 w-12 text-muji-primary transition-colors" data-target="section-plan">
            <i class="fa-regular fa-calendar-days text-xl mb-0.5"></i>
            PLAN
        </button>
        <!-- GUIDE button removed -->
        <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-wallet">
            <i class="fa-solid fa-wallet text-xl mb-0.5"></i>
            WALLET
        </button>
        <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-lists">
            <i class="fa-solid fa-list-check text-xl mb-0.5"></i>
            LISTS
        </button>
        <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-info">
            <i class="fa-solid fa-circle-info text-xl mb-0.5"></i>
            INFO
        </button>
    </nav>

    <!-- Scripts -->
    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Error', err));
            });
        }

        // --- Data & State ---
        // 類別顏色映射
        const categoryMap = {
            'Attraction': { name: '景點', color: 'bg-attraction', icon: 'fa-archway' },
            'Restaurant': { name: '餐廳', color: 'bg-restaurant', icon: 'fa-utensils' },
            'Shopping': { name: '逛街', color: 'bg-shopping', icon: 'fa-bag-shopping' },
            'Transport': { name: '交通', color: 'bg-transport', icon: 'fa-bus' },
            'Accommodation': { name: '住宿', color: 'bg-indigo-400', icon: 'fa-bed' },
            'Other': { name: '其他', color: 'bg-stone-400', icon: 'fa-circle' }
        };

        // 旅遊行程資料
        const itineraryData = [
            {
                date: "12/18", day: "Day 1",
                events: [
                    { time: "18:15", title: "抵達仁川機場", desc: "降落，準備入境", icon: "fa-plane-arrival" },
                    { 
                        time: "19:00", 
                        title: "前往市區", 
                        desc: "選擇一：機場巴士(6001線) 約1.5小時，17,000韓元/人\n選擇二：包車/汽車 約1小時15分，600台幣/人", 
                        highlight: true, 
                        icon: "fa-bus", 
                        link: "https://maps.app.goo.gl/xuu6swMwXezqVpUk6",
                        details: {
                            story: "6001號機場巴士是前往東大門、明洞地區最方便的選擇之一，價格實惠且不必轉車。冬季時，務必在候車亭內等候，避免受寒。",
                            guide: "從仁川機場入境大廳出來後，按照指示牌找到6001號巴士站牌。上車後記得使用 T-Money 卡或購買車票。",
                            tips: [
                                { type: "重要提醒", text: "巴士車票約 17,000 KRW，準備好現金或確保 T-Money 餘額充足。" }
                            ]
                        }
                    },
                    { time: "20:30", title: "Check-in", desc: "Seoul N Hostel", icon: "fa-bed", link: "https://maps.app.goo.gl/xuu6swMwXezqVpUk6" },
                    { 
                        time: "21:00", 
                        title: "晚餐：烤肉", 
                        desc: "選項如下 (點擊導航)：", 
                        icon: "fa-utensils", 
                        subItems: [
                            { name: "1. 肉典食堂", query: "https://maps.app.goo.gl/AwpU7SAtDeqDkPC49" },
                            { name: "2. 五花肉大總統", query: "https://maps.app.goo.gl/T5AxezQenBJoT6Hp7" }
                        ],
                        details: {
                            story: "首爾的烤肉文化不可錯過。肉典食堂以厚切五花肉與專人代烤聞名；五花肉大總統則以竹筒熟成五花肉為特色。",
                            guide: "兩家都是東大門/新設洞附近的人氣名店，建議避開正餐尖峰時間以免久候。",
                            tips: [
                                { type: "必點菜單", text: "厚切五花肉 (Samgyeopsal)、竹筒五花肉。" },
                                { type: "必吃美食", text: "搭配大醬湯或冷麵解膩。" }
                            ]
                        }
                    },
                    { time: "22:30", title: "宵夜：BHC 炸雞", desc: "＋逛逛附近衣服批發盛況", icon: "fa-drumstick-bite", link: "https://maps.app.goo.gl/GCE9XvyhQftPSuMF6" }
                ]
            },
            {
                date: "12/19", day: "Day 2",
                events: [
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "2014號巴士 12分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FUQxbA0l" 
                    },
                    { 
                        time: "08:30", 
                        title: "廣藏市場", 
                        desc: "糯米麻花捲、綠豆煎餅、紫菜飯捲、冷蕎麥麵", 
                        icon: "fa-store", 
                        link: "Gwangjang Market",
                        details: {
                            story: "廣藏市場是韓國歷史最悠久的傳統市場，起源於1905年。它現在已成為首爾最具代表性的美食天堂，保留了傳統市集的喧囂和人情味。",
                            guide: "市場主要分為美食區和布料區。建議在早上前往，避開晚餐高峰。",
                            tips: [
                                { type: "必吃美食", text: "綠豆煎餅 (Bindae-tteok)。" },
                                { type: "必點菜單", text: "麻藥飯捲 (Mayak Gimbap)。" }
                            ]
                        } 
                    },
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "巴士 30分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FnVHdQGL" 
                    },
                    { time: "11:00", title: "北村韓屋村 / 三清洞", desc: "含三清洞壁畫街散策", icon: "fa-camera", link: "Bukchon Hanok Village" },
                    { 
                        time: "12:00", 
                        title: "美味午餐", 
                        desc: "選項如下 (點擊導航)：", 
                        icon: "fa-utensils",
                        subItems: [
                            { name: "三清洞摩西年糕鍋", query: "https://maps.app.goo.gl/VzuKUJ2dFFSvtM25A" },
                            { name: "三清洞牛肉湯", query: "https://maps.app.goo.gl/5AZpq3AuQq7nPqBt7" }, 
                            { name: "黃生家刀切麵", query: "https://maps.app.goo.gl/Yo49wwxWHxUG54Ra8" }
                        ]
                    },
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "鐘路11號巴士 30分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/5V81ifdD"
                    },
                    { 
                        time: "14:30", 
                        title: "南大門市場", 
                        desc: "批發/童裝", 
                        icon: "fa-bag-shopping",
                        subItems: [
                            { name: "卡梅谷手工王包子", query: "https://maps.app.goo.gl/91Jaf4Q5iC7VGjuH9" },
                            { name: "Plan B: 首爾站樂天Outlet", query: "Lotte Outlets Seoul Station" }
                        ]
                    },
                    { // Bus Segment
                        time: "Travel", 
                        title: "移動 (巴士)", 
                        desc: "406, 401, 505巴士 10分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/xslXSsTO" 
                    },
                    { // Walk Segment
                        time: "Travel", 
                        title: "移動 (步行)", 
                        desc: "走路 15分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/Ig45dKD6" 
                    },
                    { 
                        time: "16:00", 
                        title: "N 首爾塔", 
                        desc: "搭纜車電梯 (日落 17:20)\n明洞搭05或03循環巴士直達山頂", 
                        icon: "fa-tower-broadcast", 
                        link: "N Seoul Tower",
                        details: {
                            story: "N 首爾塔位於南山頂，是首爾的地標性建築。塔上的數位觀景台提供360度全景視野，冬季夜晚景色尤其壯觀。著名的愛情鎖牆也在此處。",
                            guide: "可以到纜車電梯直上纜車搭乘處。上山有多種方式：纜車、循環巴士（02, 03, 05號）。循環巴士最為經濟且直接到達，但如果想體驗纜車浪漫，則需從明洞站步行至纜車站。",
                            tips: [
                                { type: "重要預約代號", text: "如果選擇纜車，建議提前在線上訂票，節省排隊時間。" },
                                { type: "必買伴手禮", text: "在山下或塔頂的紀念品店購買一個愛情鎖掛上去。" }
                            ]
                        } 
                    },
                    { // New Link for Cable Car Elevator
                        time: "Travel", 
                        title: "纜車電梯", 
                        desc: "前往搭乘處", 
                        isTravel: true,
                        linkUrl: "https://maps.app.goo.gl/vMcPPfzL3UnDCUZ5A"
                    },
                    { // Bus Segment (New)
                        time: "Travel", 
                        title: "移動", 
                        desc: "406, 401, 143 巴士 15分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/5OtHHlQ4" 
                    },
                    { 
                        time: "19:00", 
                        title: "明洞商圈 & 晚餐", 
                        desc: "明洞新世界百貨", 
                        icon: "fa-shop",
                        subItems: [
                            { name: "糖葫蘆小哥 (Noon Square前)", query: "Noon Square" },
                            { name: "神仙雪濃湯", query: "Sinseon Seolnongtang Myeongdong" },
                            { name: "味成屋雪濃湯", query: "Miseongok" }
                        ],
                        details: {
                            story: "明洞是首爾最受歡迎的購物區之一，但近年來已轉變為國際化觀光區，充滿了美妝店、服飾店和街頭小吃。每年底的新世界百貨聖誕燈飾是必看景點。",
                            guide: "晚餐推薦品嚐一碗熱騰騰的雪濃湯，特別是在寒冷的冬天。街頭小吃則推薦魚板串、烤腸等。",
                            tips: [
                                { type: "必吃美食", text: "街邊的現烤龍蝦或巨大的草莓糖葫蘆。" }
                            ]
                        }
                    }
                ]
            },
            {
                date: "12/20", day: "Day 3",
                events: [
                    { time: "07:30", title: "晨間慢跑", desc: "駱山公園 (單程2.1km上坡)、梨花洞壁畫村", icon: "fa-person-running", link: "Naksan Park" },
                    { 
                        time: "10:00", 
                        title: "東大門早午餐", 
                        desc: "美味韓食", 
                        icon: "fa-bowl-food",
                        subItems: [
                            { name: "香港飯店0410PLUS", query: "Hong Kong Banjeom 0410 Dongdaemun" },
                            { name: "海苔飯捲", query: "https://maps.app.goo.gl/VkmVHP1PaFgTTojW6" }
                        ]
                    },
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "地鐵 20分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/xnro2gSz"
                    },
                    { // --- MODIFIED: ADDED '站' ---
                        time: "12:00", 
                        title: "狎鷗亭羅德奧站", 
                        desc: "逛逛行程", 
                        icon: "fa-bag-shopping",
                        subItems: [
                            { name: "Jayeondo 鹽麵包", query: "Jayeondo Sogeumppang Apgujeong" },
                            { name: "HDEX HYM DOSAN", query: "HDEX HYM DOSAN" }
                        ],
                        details: {
                            story: "狎鷗亭羅德奧是首爾江南區時尚與奢華的代名詞，聚集了許多設計師品牌、旗艦店和高檔咖啡廳，是體驗首爾K-Pop文化和潮流的絕佳地點。",
                            guide: "這區的咖啡廳很多都是獨棟設計，環境優美。HDEX HYM DOSAN是運動潮流品牌，若有興趣可前往參觀。",
                            tips: [
                                { type: "必吃美食", text: "Jayeondo Sogeumppang 的招牌鹽麵包 (Sogeumppang)，口感酥脆內部鬆軟。" }
                            ]
                        }
                    },
                    { 
                        time: "13:00", 
                        title: "醫美行程", 
                        desc: "V-moment", 
                        highlight: true, 
                        icon: "fa-sparkles", 
                        link: "https://maps.app.goo.gl/xmni7wxBmHpTjxH48"
                        // Details removed as requested
                    },
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "巴士 20分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/GmtvjJbO"
                    },
                    { 
                        time: "16:00", 
                        title: "星空圖書館", 
                        desc: "@ Coex Mall", 
                        icon: "fa-book-open", 
                        link: "Starfield Library",
                        details: {
                            story: "星空圖書館位於 COEX Mall 中心，是首爾的打卡熱點，以其高達13公尺的巨大書架和開放式設計著稱。夜晚的燈光效果非常壯觀。",
                            guide: "圖書館內座位有限，主要以拍照和休憩為主。商場內有許多餐廳和商店，可以安排晚餐和購物。",
                            tips: [
                                { type: "重要提醒", text: "最佳拍攝時間為傍晚，燈光全開時。" }
                            ]
                        }
                    },
                    { 
                        time: "Travel", 
                        title: "移動", 
                        desc: "地鐵 50分鐘", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FlcwoRT4"
                    },
                    { time: "18:00", title: "聖誕氛圍", desc: "光化門聖誕市集、清溪川燈節 (六日18:00~22:00)", icon: "fa-tree", link: "Gwanghwamun Square" }
                ]
            },
            {
                date: "12/21", day: "Day 4",
                events: [
                    { time: "07:30", title: "前往機場", desc: "搭乘 6001 號機場巴士", highlight: true, icon: "fa-bus", category: "Transport" },
                    { time: "11:50", title: "飛機起飛", desc: "RF5193 (ICN-HUN)", icon: "fa-plane-departure", category: "Transport" },
                    { time: "13:30", title: "抵達溫暖的家", desc: "平安歸來", icon: "fa-house", category: "Other" }
                ]
            }
        ];

        // --- FIXED: Define defaultChecklist here ---
        const defaultChecklist = [
            { text: "韓國線上入境卡 (Q-Code)", checked: false },
            { text: "Esim / 網卡", checked: false },
            { text: "轉接頭 (圓孔)", checked: false },
            { text: "T-money 悠遊卡", checked: false },
            { text: "護照", checked: false },
            { text: "台幣現金", checked: false },
            { text: "行動電源", checked: false }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPlanTabs();
            renderPlanContent(0);
            initWallet();
            initLists();
            
            // Calculator Input Listener
            document.getElementById('calc-input').addEventListener('input', calculateTotal);
            
            // Setup Tab Style Logic
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    navBtns.forEach(b => {
                        b.classList.remove('text-muji-primary');
                        b.classList.add('text-stone-400');
                    });
                    this.classList.remove('text-stone-400');
                    this.classList.add('text-muji-primary');
                });
            });
        });

        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`section-${tabId}`).classList.add('active');
            window.scrollTo(0, 0);
        }

        // --- PLAN Section Logic (Updated to Card View) ---
        function renderPlanTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = itineraryData.map((day, index) => `
                <button onclick="renderPlanContent(${index})" 
                    class="day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all ${index === 0 ? 'bg-stone-800 text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}" 
                    data-index="${index}">
                    <span class="block text-xs opacity-70">${day.date}</span>
                    <span>${day.day}</span>
                </button>
            `).join('');
        }

        function renderPlanContent(dayIndex) {
            // Update Tab Styles
            document.querySelectorAll('.day-tab-btn').forEach(btn => {
                if (parseInt(btn.dataset.index) === dayIndex) {
                    btn.className = "day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all bg-stone-800 text-white shadow-md transform scale-105";
                } else {
                    btn.className = "day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all bg-white text-stone-500 border border-stone-200";
                }
            });

            // Render Cards
            const day = itineraryData[dayIndex];
            const container = document.getElementById('itinerary-content');
            
            let html = '';
            day.events.forEach((event, index) => {
                const timeColor = event.highlight ? 'text-muji-highlight' : 'text-muji-primary';
                
                // Travel Card - Simplified
                if (event.isTravel) {
                    let travelContent = `<span class="text-stone-500">${event.desc}</span>`;
                    if (event.linkUrl) {
                        travelContent += ` <a href="${event.linkUrl}" target="_blank" class="ml-1 text-muji-highlight underline"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>`;
                    }
                    html += `
                        <div class="flex items-center gap-4 bg-stone-100 p-3 rounded-xl border border-stone-200">
                            <i class="fa-solid fa-route text-2xl text-stone-400 min-w-[30px] text-center"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-stone-700">${event.title}</h4>
                                <div class="text-xs text-stone-500 font-mono">${travelContent}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sub Items (Buttons)
                    let linkBtn = '';
                    if (event.link) {
                        // Check if link is URL or Query
                        const href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                        linkBtn = `
                            <a href="${href}" target="_blank" 
                               onclick="event.stopPropagation()"
                               class="inline-block mt-2 text-xs bg-stone-100 text-stone-600 px-3 py-1.5 rounded-md hover:bg-stone-200">
                               <i class="fa-solid fa-map-location-dot mr-1"></i> 地圖
                            </a>
                        `;
                    }
                    if (event.subItems) {
                        linkBtn = `<div class="mt-3 flex flex-wrap gap-2">`;
                        event.subItems.forEach(item => {
                            // Check if item query is a URL or search query
                            const itemHref = item.query.startsWith('http') ? item.query : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.query)}`;
                            linkBtn += `
                                <a href="${itemHref}" target="_blank" 
                                   onclick="event.stopPropagation()"
                                   class="inline-block text-xs border border-stone-200 text-stone-600 px-3 py-1.5 rounded-md hover:bg-stone-50 hover:border-stone-300">
                                   <i class="fa-solid fa-location-dot mr-1 text-stone-400"></i> ${item.name}
                                </a>
                            `;
                        });
                        linkBtn += `</div>`;
                    }

                    // Standard Clickable Card
                    html += `
                        <div onclick="openDetailModal(${dayIndex}, ${index})"
                             class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 cursor-pointer active:scale-[0.99] transition-transform">
                            <div class="flex justify-between items-start">
                                <div class="flex flex-col">
                                    <span class="text-sm ${timeColor} font-mono">${event.time}</span>
                                    <h4 class="font-bold text-lg text-stone-800 mt-0.5">${event.title}</h4>
                                </div>
                                <i class="fa-solid ${event.icon} text-2xl text-stone-300"></i>
                            </div>
                            <p class="text-sm text-muji-sub mt-2">${event.desc.replace(/\n/g, '<br>')}</p>
                            ${linkBtn}
                        </div>
                    `;
                }
            });
            container.innerHTML = html;
        }

        function openDetailModal(dayIndex, eventIndex) {
            const event = itineraryData[dayIndex].events[eventIndex];
            const modalOverlay = document.getElementById('detail-modal-overlay');
            
            // Check if details exist
            if (!event.details) {
                // If no details, just open the map link or show a simplified view
                if (event.link) {
                    const href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                    window.open(href, '_blank');
                    return;
                }
                // Fallback to simple description if no map link either
                alert(`[${event.time}] ${event.title}\n\n${event.desc}\n\n此行程無詳細攻略。`);
                return;
            }

            // Set Modal Content
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-story').innerText = event.details.story || "暫無詳細故事";
            document.getElementById('modal-guide').innerText = event.details.guide || "暫無詳細攻略";
            
            // Map Link
            const mapLink = document.getElementById('modal-map-link');
            if (event.link) {
                mapLink.href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                mapLink.style.display = 'block';
            } else {
                mapLink.style.display = 'none';
            }
            
            // Tips Rendering
            const tipsContainer = document.getElementById('modal-tips');
            let tipsHtml = '';
            
            const tipColorMap = {
                '必吃美食': 'bg-red-100 text-red-700 border-red-200',
                '必點菜單': 'bg-green-100 text-green-700 border-green-200',
                '必買伴手禮': 'bg-blue-100 text-blue-700 border-blue-200',
                '重要預約代號': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                '重要提醒': 'bg-yellow-100 text-yellow-700 border-yellow-200'
            };

            if (event.details.tips && event.details.tips.length > 0) {
                event.details.tips.forEach(tip => {
                    const tipClass = tipColorMap[tip.type] || 'bg-stone-100 text-stone-700 border-stone-200';
                    tipsHtml += `
                        <div class="p-3 rounded-lg border ${tipClass}">
                            <strong class="text-sm font-bold block mb-1">${tip.type}</strong>
                            <p class="text-sm">${tip.text}</p>
                        </div>
                    `;
                });
                document.getElementById('modal-tips-container').style.display = 'block';
            } else {
                document.getElementById('modal-tips-container').style.display = 'none';
            }
            tipsContainer.innerHTML = tipsHtml;

            // Show Modal
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeDetailModal(event) {
            const modalOverlay = document.getElementById('detail-modal-overlay');
            if (event && event.target !== modalOverlay) return; // Only close if clicking overlay

            modalOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling
        }


        // --- WALLET Section Logic ---
        let expenseChart = null; // Global variable for chart instance

        function initWallet() {
            // Rate
            const savedRate = localStorage.getItem('krw_rate');
            if (savedRate) document.getElementById('exchange-rate').value = savedRate;
            
            // Expenses
            renderExpenseList();
        }

        function updateRate() {
            const rate = document.getElementById('exchange-rate').value;
            localStorage.setItem('krw_rate', rate);
            renderExpenseList(); // Update totals in list
            calculateTotal(); // Update calculator
            renderChart(); // Update chart
        }

        function calculateTotal() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42; 
            
            if (/^[0-9+\-*/.() ]*$/.test(input) && input.trim() !== "") {
                try {
                    const result = new Function('return ' + input)();
                    if (isFinite(result)) {
                        document.getElementById('calc-result-krw').innerText = Math.round(result).toLocaleString() + " ₩";
                        const twd = Math.round(result / rate);
                        document.getElementById('calc-result-twd').innerText = "NT$ " + twd.toLocaleString();
                        return result;
                    }
                } catch (e) {}
            }
            
            if(input.trim() === "") {
                document.getElementById('calc-result-krw').innerText = "0 ₩";
                document.getElementById('calc-result-twd').innerText = "0 NT$";
            }
            return 0;
        }

        function copyCalcToExpense() {
            const result = calculateTotal();
            if (result > 0) {
                document.getElementById('expense-amount').value = Math.round(result);
                document.getElementById('expense-name').focus();
            }
        }

        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;
            const category = document.getElementById('expense-category').value;
            
            if (!name || isNaN(amount)) return;

            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.unshift({
                id: Date.now(),
                name: name,
                amount: amount,
                payer: payer,
                category: category,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            // Reset form
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            
            renderExpenseList();
            if(!document.getElementById('wallet-view-chart').classList.contains('hidden')) {
                renderChart();
            }
        }

        function deleteExpense(id) {
            let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenseList();
            if(!document.getElementById('wallet-view-chart').classList.contains('hidden')) {
                renderChart();
            }
        }

        function toggleWalletView(view) {
            const listBtn = document.getElementById('btn-view-list');
            const chartBtn = document.getElementById('btn-view-chart');
            const listView = document.getElementById('wallet-view-list');
            const chartView = document.getElementById('wallet-view-chart');

            if (view === 'list') {
                listBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
                listBtn.classList.remove('text-stone-500');
                chartBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
                chartBtn.classList.add('text-stone-500');
                listView.classList.remove('hidden');
                chartView.classList.add('hidden');
            } else {
                chartBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
                chartBtn.classList.remove('text-stone-500');
                listBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
                listBtn.classList.add('text-stone-500');
                listView.classList.add('hidden');
                chartView.classList.remove('hidden');
                renderChart();
            }
        }

        function renderExpenseList() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const list = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42;
            
            let totalTWD = 0;
            let totalKathy = 0;
            let totalNick = 0;

            const categoryIcons = {
                'food': '<i class="fa-solid fa-utensils text-rose-400"></i>',
                'transport': '<i class="fa-solid fa-bus text-blue-400"></i>',
                'stay': '<i class="fa-solid fa-bed text-indigo-400"></i>',
                'other': '<i class="fa-solid fa-bag-shopping text-stone-400"></i>'
            };

            list.innerHTML = expenses.map(e => {
                const twd = Math.round(e.amount / rate);
                totalTWD += twd;
                
                // Payer logic (Backward compatibility: if no payer, assume unknown or default)
                const payer = e.payer || 'Kathy'; 
                if (payer === 'Kathy') totalKathy += twd;
                if (payer === 'Nick') totalNick += twd;

                const payerBadgeClass = payer === 'Nick' 
                    ? 'bg-stone-600 text-white' 
                    : 'bg-stone-200 text-stone-600';
                
                const catIcon = categoryIcons[e.category || 'other'];

                return `
                    <li class="bg-white p-3 rounded-lg shadow-sm border border-stone-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-xs">
                                ${catIcon}
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${payerBadgeClass}">${payer}</span>
                                    <div class="font-medium text-stone-700">${e.name}</div>
                                </div>
                                <div class="text-xs text-stone-400">${e.date}</div>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <div>
                                <div class="text-sm font-bold text-stone-800">₩${e.amount.toLocaleString()}</div>
                                <div class="text-xs text-muji-sub">≈ NT$${twd.toLocaleString()}</div>
                            </div>
                            <button onclick="deleteExpense(${e.id})" class="text-stone-300 hover:text-red-400 px-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                `;
            }).join('');

            document.getElementById('total-twd').innerText = `NT$ ${totalTWD.toLocaleString()}`;
            document.getElementById('total-kathy').innerText = `NT$ ${totalKathy.toLocaleString()}`;
            document.getElementById('total-nick').innerText = `NT$ ${totalNick.toLocaleString()}`;
        }

        function renderChart() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42;
            
            // Prepare Data
            const categories = {
                'food': { label: '食', total: 0, color: '#f87171' }, // Red
                'transport': { label: '交通', total: 0, color: '#60a5fa' }, // Blue
                'stay': { label: '住宿', total: 0, color: '#2e8f83' }, // Green
                'other': { label: '其他', total: 0, color: '#a8a29e' } // Stone
            };

            expenses.forEach(e => {
                const cat = e.category || 'other';
                categories[cat].total += Math.round(e.amount / rate);
            });

            const labels = Object.values(categories).map(c => c.label);
            const data = Object.values(categories).map(c => c.total);
            const backgroundColors = Object.values(categories).map(c => c.color);

            // Update Summary List under Chart
            const summaryList = document.getElementById('category-summary-list');
            let summaryHTML = '';
            let total = data.reduce((a, b) => a + b, 0);
            
            Object.values(categories).forEach(c => {
                const percentage = total > 0 ? Math.round((c.total / total) * 100) : 0;
                summaryHTML += `
                    <div class="flex justify-between items-center text-sm border-b border-stone-100 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${c.color}"></span>
                            <span class="text-stone-600">${c.label}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-stone-800">NT$ ${c.total.toLocaleString()}</span>
                            <span class="text-xs text-stone-400 ml-1">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            });
            summaryList.innerHTML = summaryHTML;

            // Render Chart
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (expenseChart) {
                expenseChart.destroy();
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: "'Noto Sans TC', sans-serif",
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        // --- LISTS Section Logic ---
        function initLists() {
            // Checklist
            let checklist = JSON.parse(localStorage.getItem('checklist'));
            if (!checklist) {
                checklist = defaultChecklist;
                localStorage.setItem('checklist', JSON.stringify(checklist));
            }
            renderChecklist();

            // Memo
            const memo = localStorage.getItem('user_memo') || '';
            const textarea = document.getElementById('memo-area');
            textarea.value = memo;
            extractLinks(memo);

            textarea.addEventListener('input', (e) => {
                localStorage.setItem('user_memo', e.target.value);
                extractLinks(e.target.value);
            });
        }

        function toggleCheck(index) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist[index].checked = !checklist[index].checked;
            localStorage.setItem('checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function updateChecklistText(index, newText) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist[index].text = newText;
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }

        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const text = input.value.trim();
            if (text) {
                const checklist = JSON.parse(localStorage.getItem('checklist')) || [];
                checklist.push({ text: text, checked: false });
                localStorage.setItem('checklist', JSON.stringify(checklist));
                input.value = ''; // Clear input
                renderChecklist();
                
                // Focus back on the new input after render
                setTimeout(() => document.getElementById('new-checklist-item').focus(), 100);
            }
        }

        function deleteChecklistItem(index) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist.splice(index, 1);
            localStorage.setItem('checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function renderChecklist() {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            const container = document.getElementById('checklist-container');
            
            container.innerHTML = checklist.map((item, index) => `
                <div class="flex items-center space-x-3 bg-white p-3 rounded-lg shadow-sm border border-stone-100 group">
                    <input type="checkbox" class="muji-checkbox w-5 h-5 flex-shrink-0 rounded border-stone-300 text-stone-600 focus:ring-stone-500" 
                        ${item.checked ? 'checked' : ''} onchange="toggleCheck(${index})">
                    
                    <input type="text" class="input-ghost text-sm text-stone-700 ${item.checked ? 'line-through opacity-50' : ''}"
                        value="${item.text}" onchange="updateChecklistText(${index}, this.value)">
                        
                    <button onclick="deleteChecklistItem(${index})" class="text-stone-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `).join('');
        }

        function extractLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            const container = document.getElementById('memo-links');
            
            if (matches) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="text-xs bg-stone-200 text-stone-600 px-2 py-1 rounded hover:bg-stone-300 truncate max-w-[150px] block">
                        <i class="fa-solid fa-link mr-1"></i> 連結
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // --- Utils ---
        function resetApp() {
            if(confirm('確定要重置所有資料嗎？(記帳和清單都會清空)')) {
                localStorage.clear();
                location.reload();
            }
        }

    </script>
</body>
</html>
