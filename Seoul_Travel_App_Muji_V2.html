<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¦–çˆ¾å†¬æ—¥æ—… | Seoul Trip</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Google Fonts: Noto Sans (UI) & Noto Serif (Headers) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js for Wallet Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Configuration for Tailwind to match Muji Style -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: {
                            bg: '#fdfcf8',       /* æº«æš–çš„ç±³ç™½ç´™å¼µè‰² */
                            card: '#ffffff',     /* ç´”ç™½å¡ç‰‡ */
                            text: '#44403c',     /* æ·±ç° Stone-700 */
                            sub: '#78716c',      /* æ·ºç° Stone-500 */
                            accent: '#a8a29e',   /* è£é£¾ç° Stone-400 */
                            primary: '#57534e',  /* ä¸»æŒ‰éˆ• Stone-600 */
                            highlight: '#d97706' /* é‡é»æé†’ Amber-600 (æŸ”å’Œæ©˜) */
                        },
                        attraction: '#34d399', // Emerald Green
                        restaurant: '#f87171', // Red
                        shopping: '#60a5fa',   // Blue
                        transport: '#a78bfa'  // Violet
                    }
                },
                fontFamily: {
                    sans: ['"Noto Sans TC"', 'sans-serif'],
                    serif: ['"Noto Serif TC"', 'serif'],
                }
            }
        }
    </script>

    <style>
        /* å…¨å±€è¨­å®š */
        body {
            background-color: #fdfcf8;
            color: #44403c;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; /* ğŸ”´ é˜²æ­¢æ‰‹æ©Ÿæ©«å‘çˆ†ç‰ˆ */
        }
        
        /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* é é¢åˆ‡æ›å‹•ç•« */
        .page-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            padding-bottom: 120px; /* å¢åŠ åº•éƒ¨é–“è·ï¼Œç¢ºä¿å…§å®¹ä¸æœƒè¢«å°èˆªåˆ—é®æ“‹ */
        }
        .page-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modal æ¨£å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            display: block;
            opacity: 1;
        }
        .modal-content {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 85%;
            background: #fdfcf8;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Checklist Input Ghost Style */
        .input-ghost {
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
        }
        .muji-checkbox:checked {
            background-color: #57534e;
            border-color: #57534e;
        }

        /* --- å‡ç´šç‰ˆé–‹å ´å‹•ç•« (Intro) --- */
        #intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #fdfcf8;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* 3ç§’å‹•ç•«çµæŸå¾Œæ·¡å‡ºéš±è— */
            animation: hideIntro 0.5s ease-out 3s forwards;
            pointer-events: none; /* é¿å…æ“‹ä½é»æ“Š */
        }

        #intro-text {
            font-family: 'Noto Serif TC', serif;
            font-size: 5rem;
            font-weight: 700;
            color: #44403c;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            white-space: nowrap;
            
            /* ç¸®æ”¾ä¸­å¿ƒé»è¨­å®šåœ¨ 'S' çš„ä½ç½® (å¤§ç´„å·¦å´ 12% è™•) */
            transform-origin: 12% 55%; 
            
            /* 3ç§’ç¸®æ”¾å‹•ç•« */
            animation: zoomThrough 3s cubic-bezier(0.7, 0, 0.2, 1) forwards;
        }

        /* é‡å° 'S' çš„ç‰¹åˆ¥æ¨£å¼ */
        .intro-s {
            display: inline-block;
            background-clip: text;
            -webkit-background-clip: text;
            color: #44403c; /* åˆå§‹é¡è‰² */
            
            /* S çš„è®Šè‰²å‹•ç•« */
            animation: colorMorph 3s ease-in-out forwards;
        }

        /* ç¸®æ”¾ä¸¦ç©¿éæ–‡å­—çš„å‹•ç•« */
        @keyframes zoomThrough {
            0% {
                opacity: 0;
                transform: scale(0.5); /* åˆå§‹ç•¥å° */
            }
            15% {
                opacity: 1;
                transform: scale(1); /* æ­£å¸¸å¤§å°åœç•™ä¸€ä¸‹ */
            }
            40% {
                transform: scale(2); /* é–‹å§‹æ”¾å¤§ */
            }
            100% {
                opacity: 0; /* æœ€å¾Œæ·¡å‡º */
                transform: scale(150); /* å·¨å¤§ç¸®æ”¾ï¼Œæ¨¡æ“¬ç©¿é */
            }
        }

        /* S è®Šæˆå½©è‰²çš„å‹•ç•« */
        @keyframes colorMorph {
            0%, 20% {
                color: #44403c; /* ä¿æŒæ·±ç° */
            }
            40% {
                color: transparent;
                background-image: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); /* ç²‰å½©æ¼¸å±¤ */
            }
            100% {
                color: transparent;
                background-image: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); /* è®Šç‚ºå¤¢å¹»ç´«ç²‰ */
            }
        }

        /* éš±è—é®ç½©å±¤ */
        @keyframes hideIntro {
            to {
                opacity: 0;
                visibility: hidden;
            }
        }
    </style>
</head>
<body class="font-sans antialiased h-[100dvh] flex flex-col overflow-hidden">

    <!-- INTRO ANIMATION -->
    <div id="intro-overlay">
        <!-- å°‡ S ç”¨ span åŒ…èµ·ä¾†ä»¥ç¨ç«‹è®Šè‰² -->
        <h1 id="intro-text"><span class="intro-s">S</span>EOUL</h1>
    </div>

    <!-- Header -->
    <header class="bg-muji-bg px-6 pt-12 pb-4 sticky top-0 z-10 border-b border-stone-200/50">
        <div class="flex justify-between items-end">
            <div>
                <h1 class="font-serif text-3xl text-stone-800 tracking-wide font-bold">SEOUL</h1>
                <p class="text-sm text-muji-sub mt-1 tracking-widest uppercase">Dec 18 - Dec 21, 2024</p>
            </div>
            <div class="text-right flex flex-col justify-end">
                <div class="text-2xl font-bold text-stone-800 flex items-center justify-end">
                     <i class="fa-solid fa-snowflake text-blue-300 text-lg mr-2"></i>
                     <span class="text-sm text-stone-400">-6Â°C</span>
                </div>
                <p class="text-xs text-muji-sub mt-1">Cold Winter</p>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="flex-1 overflow-y-auto no-scrollbar relative px-0 pb-[120px]" id="main-container">

        <!-- ================= SECTION 1: PLAN (è¡Œç¨‹) ================= -->
        <div id="section-plan" class="page-section active">
            <!-- Day Tabs -->
            <div class="flex overflow-x-auto no-scrollbar px-6 py-4 gap-3 sticky top-0 bg-muji-bg/95 backdrop-blur-sm z-10" id="day-tabs">
                <!-- Javascript will render tabs here -->
            </div>

            <!-- Itinerary Content -->
            <div id="itinerary-content" class="px-6 pb-8 space-y-4">
                <!-- Javascript will render cards here -->
            </div>
        </div>

        <!-- ================= SECTION 2: WALLET (è¨˜å¸³) ================= -->
        <div id="section-wallet" class="page-section">
            <div class="bg-stone-100 p-6 pb-8 rounded-b-3xl shadow-inner mb-6">
                <!-- Rate Setting -->
                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-bold text-muji-sub uppercase tracking-wider">Exchange Rate (KRW to TWD)</label>
                    <div class="flex items-center bg-white rounded-lg px-2 py-1 shadow-sm">
                        <span class="text-xs text-stone-400 mr-2">1 TWD â‰ˆ</span>
                        <input type="number" id="exchange-rate" value="42.5" class="w-12 text-right text-sm font-bold text-stone-700 outline-none bg-transparent" onchange="updateRate()">
                        <span class="text-xs text-stone-400 ml-1">KRW</span>
                    </div>
                </div>

                <!-- Calculator -->
                <div class="bg-white rounded-xl p-4 shadow-sm border border-stone-200">
                    <div class="flex flex-col">
                        <label class="text-xs text-muji-sub mb-1">å¿«é€Ÿæ›ç®— (æ”¯æ´ + - * /)</label>
                        <div class="flex flex-col sm:flex-row sm:items-end gap-2">
                            <input type="text" id="calc-input" placeholder="ä¾‹å¦‚: 5000" class="flex-1 text-xl font-mono text-stone-800 border-b border-stone-200 focus:border-muji-primary outline py-1 bg-transparent">
                            <span class="text-stone-400 text-xl">=</span>
                            <div class="text-right sm:w-1/3 w-full">
                                <div id="calc-result-krw" class="text-xs text-stone-500 truncate">0 â‚©</div>
                                <div id="calc-result-twd" class="text-lg sm:text-2xl font-bold text-muji-highlight break-words leading-tight">0 NT$</div>
                            </div>
                        </div>
                    </div>
                    <!-- Quick Add Button -->
                    <button onclick="copyCalcToExpense()" class="w-full mt-3 bg-stone-100 text-stone-600 text-xs py-2 rounded-lg hover:bg-stone-200 transition">
                        <i class="fa-solid fa-arrow-down mr-1"></i> æŠŠè¨ˆç®—çµæœåŠ å…¥è¨˜å¸³
                    </button>
                </div>
            </div>

            <!-- Expense Form -->
            <div class="px-6 mb-8">
                <h3 class="font-serif text-lg mb-4">æ–°å¢æ¶ˆè²»</h3>
                <div class="flex flex-col gap-3">
                    <div class="flex gap-2">
                        <input type="text" id="expense-name" placeholder="å“é … (å¦‚: çƒ¤è‚‰)" class="flex-[2] bg-white border border-stone-200 rounded-lg px-3 py-3 text-sm outline-none focus:border-muji-primary">
                        <select id="expense-payer" class="flex-[1] bg-white border border-stone-200 rounded-lg px-2 py-3 text-sm outline-none focus:border-muji-primary text-stone-700">
                            <option value="Kathy">Kathy</option>
                            <option value="Nick">Nick</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="expense-amount" placeholder="â‚© éŸ“å¹£é‡‘é¡" class="flex-[2] bg-white border border-stone-200 rounded-lg px-3 py-3 text-sm outline-none focus:border-muji-primary">
                        <select id="expense-category" class="flex-[1] bg-white border border-stone-200 rounded-lg px-2 py-3 text-sm outline-none focus:border-muji-primary text-stone-700">
                            <option value="food">é£Ÿ</option>
                            <option value="transport">äº¤é€š</option>
                            <option value="stay">ä½å®¿</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>
                    <button onclick="addExpense()" class="w-full bg-muji-primary text-white py-3 rounded-lg shadow-md active:scale-95 transition text-sm font-medium tracking-wide">
                        è¨˜å¸³
                    </button>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="px-6 mb-4 flex justify-center">
                <div class="bg-stone-100 p-1 rounded-lg inline-flex">
                    <button onclick="toggleWalletView('list')" id="btn-view-list" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-stone-800 shadow-sm transition-all">åˆ—è¡¨</button>
                    <button onclick="toggleWalletView('chart')" id="btn-view-chart" class="px-4 py-1.5 rounded-md text-xs font-bold text-stone-500 hover:text-stone-800 transition-all">åœ–è¡¨åˆ†æ</button>
                </div>
            </div>

            <!-- Expense List & Summary (Default View) -->
            <div id="wallet-view-list" class="px-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center">
                        <span class="block text-xs text-stone-400 mb-1">Kathy Paid</span>
                        <span id="total-kathy" class="font-bold text-stone-700">NT$ 0</span>
                    </div>
                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-200 text-center">
                        <span class="block text-xs text-stone-400 mb-1">Nick Paid</span>
                        <span id="total-nick" class="font-bold text-stone-700">NT$ 0</span>
                    </div>
                </div>

                <div class="flex justify-between items-end mb-4 border-b border-stone-200 pb-2">
                    <h3 class="font-serif text-lg">æ¶ˆè²»ç´€éŒ„</h3>
                    <div class="text-right">
                        <span class="text-xs text-muji-sub block">ç¸½æ”¯å‡º (Total)</span>
                        <span id="total-twd" class="font-bold text-muji-text">NT$ 0</span>
                    </div>
                </div>
                <ul id="expense-list" class="space-y-3 pb-20">
                    <!-- Javascript will render list here -->
                </ul>
            </div>

            <!-- Chart View (Hidden by default) -->
            <div id="wallet-view-chart" class="px-6 hidden pb-20">
                <div class="bg-white p-4 rounded-xl border border-stone-100 shadow-sm">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div class="mt-6 space-y-3" id="category-summary-list">
                    <!-- Category breakdown text will go here -->
                </div>
            </div>
        </div>

        <!-- ================= SECTION 3: LISTS (æ¸…å–®) ================= -->
        <div id="section-lists" class="page-section">
            <div class="px-6 py-4 space-y-8">
                
                <!-- Checklist -->
                <div>
                    <h3 class="font-serif text-xl mb-4 border-l-4 border-muji-primary pl-3">è¡Œå‰æº–å‚™</h3>
                    <p class="text-xs text-stone-400 mb-2">é»æ“Šæ–‡å­—å¯ä¿®æ”¹ï¼Œä¸‹æ–¹è¼¸å…¥æ¡†å¯æ–°å¢ã€‚</p>
                    <div id="checklist-container" class="space-y-3">
                        <!-- JS Render -->
                    </div>
                    <!-- Add New Item Input -->
                    <div class="mt-3 flex items-center space-x-3 bg-stone-50 p-3 rounded-lg border border-dashed border-stone-300">
                        <i class="fa-solid fa-plus text-stone-400 ml-1"></i>
                        <input type="text" id="new-checklist-item" placeholder="æ–°å¢é …ç›®..." 
                               class="bg-transparent text-sm outline-none text-stone-600 w-full placeholder-stone-400"
                               onkeydown="if(event.key === 'Enter') addChecklistItem()">
                    </div>
                </div>

                <!-- Memo -->
                <div>
                    <h3 class="font-serif text-xl mb-4 border-l-4 border-stone-300 pl-3">å€‹äººå‚™å¿˜éŒ„</h3>
                    <div class="bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden relative group">
                        <textarea id="memo-area" class="w-full h-48 p-4 text-sm leading-relaxed text-stone-700 outline-none resize-none bg-yellow-50/20" placeholder="åœ¨æ­¤è¼¸å…¥ç­†è¨˜ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›ç‚ºé€£çµ..."></textarea>
                        <div class="absolute bottom-2 right-2 text-xs text-stone-300">Auto-saving</div>
                    </div>
                    <!-- Link Preview Area -->
                    <div id="memo-links" class="mt-4 flex flex-wrap gap-2">
                        <!-- Extracted Links appear here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= SECTION 4: INFO (è³‡è¨Š) ================= -->
        <div id="section-info" class="page-section">
            <div class="px-6 py-4 space-y-6">

                <!-- 1. Flight Info (Top) -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <h3 class="text-sm font-bold text-stone-400 mb-3 tracking-wider uppercase">Flights é£›æ©Ÿèˆªç­æ™‚é–“</h3>
                    <div class="mb-4 pb-4 border-b border-stone-100">
                        <div class="flex justify-between text-lg font-bold text-stone-800">
                            <span>HUN</span> <i class="fa-solid fa-plane text-xs text-stone-300 self-center"></i> <span>ICN</span>
                        </div>
                        <div class="flex justify-between text-sm text-muji-sub mt-1">
                            <span>12/18 14:45</span> <span>RF5203</span> <span>18:15</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-lg font-bold text-stone-800">
                            <span>ICN</span> <i class="fa-solid fa-plane text-xs text-stone-300 self-center"></i> <span>HUN</span>
                        </div>
                        <div class="flex justify-between text-sm text-muji-sub mt-1">
                            <span>12/21 11:50</span> <span>RF5193</span> <span>13:30</span>
                        </div>
                    </div>
                </div>
                
                <!-- 2. Weather Widget -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-stone-400 tracking-wider uppercase">Seoul Weather é¦–çˆ¾å¤©æ°£</h3>
                        <span class="text-[10px] text-stone-300">Source: KMA</span>
                    </div>
                    <!-- Horizontal Scroll for Weekly Forecast -->
                    <div class="flex overflow-x-auto no-scrollbar gap-4 pb-2">
                        <!-- Day 18 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/18</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-6Â°C</span>
                            <span class="text-[10px] text-stone-400">æ™´æœ—</span>
                        </div>
                        <!-- Day 19 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/19</span>
                            <i class="fa-solid fa-cloud-sun text-2xl text-stone-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-4Â°C</span>
                            <span class="text-[10px] text-stone-400">å¤šé›²</span>
                        </div>
                        <!-- Day 20 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/20</span>
                            <i class="fa-solid fa-snowflake text-2xl text-blue-200 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-5Â°C</span>
                            <span class="text-[10px] text-stone-400">å°é›ª</span>
                        </div>
                        <!-- Day 21 -->
                        <div class="flex flex-col items-center min-w-[60px]">
                            <span class="text-xs text-stone-500 mb-1">12/21</span>
                            <i class="fa-solid fa-cloud text-2xl text-stone-300 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-2Â°C</span>
                            <span class="text-[10px] text-stone-400">é™°å¤©</span>
                        </div>
                        <!-- Day 22 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-70">
                            <span class="text-xs text-stone-500 mb-1">12/22</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-3Â°C</span>
                            <span class="text-[10px] text-stone-400">æ™´æœ—</span>
                        </div>
                        <!-- Day 23 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-70">
                            <span class="text-xs text-stone-500 mb-1">12/23</span>
                            <i class="fa-solid fa-cloud-sun text-2xl text-stone-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">-1Â°C</span>
                            <span class="text-[10px] text-stone-400">å¤šé›²</span>
                        </div>
                        <!-- Day 24 -->
                        <div class="flex flex-col items-center min-w-[60px] opacity-50">
                            <span class="text-xs text-stone-500 mb-1">12/24</span>
                            <i class="fa-solid fa-sun text-2xl text-amber-400 mb-2"></i>
                            <span class="text-sm font-bold text-stone-700">0Â°C</span>
                            <span class="text-[10px] text-stone-400">å¹³å®‰å¤œ</span>
                        </div>
                    </div>
                </div>
                
                <!-- 3. Accommodation -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-16 h-16 bg-stone-100 rounded-bl-full -mr-8 -mt-8"></div>
                    <h3 class="text-sm font-bold text-stone-400 mb-2 tracking-wider uppercase">Accommodation ä½å®¿è³‡è¨Š</h3>
                    <h2 class="text-xl font-serif text-stone-800 mb-1">Seoul N Hostel</h2>
                    <p class="text-xs text-stone-500 mb-4 w-3/4">159-16 Mareunnae-ro, Jung District, Seoul</p>
                    <a href="https://maps.app.goo.gl/xuu6swMwXezqVpUk6" target="_blank" class="inline-block bg-stone-800 text-white text-xs px-4 py-2 rounded-full shadow-md">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> å°èˆª
                    </a>
                </div>

                <!-- 4. Electronic Arrival Card (K-ETA / Q-Code) - NEW SECTION -->
                <div class="bg-white rounded-xl p-5 shadow-sm border border-stone-100">
                    <h3 class="text-sm font-bold text-stone-400 mb-3 tracking-wider uppercase">Arrival Card é›»å­å…¥å¢ƒå¡</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Image 1 Placeholder -->
                        <div class="border border-stone-200 rounded-lg p-2 bg-stone-50 text-center">
                            <div class="aspect-[3/4] bg-stone-200 rounded flex items-center justify-center mb-2 overflow-hidden">
                                <!-- Replace src with actual path if files are local, e.g. "IMG_2066.jpg" -->
                                <img src="IMG_2066.jpg" alt="é›»å­å…¥å¢ƒå¡ 1" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x400/e5e5e5/a3a3a3?text=IMG_2066.jpg';">
                            </div>
                            <span class="text-xs text-stone-500">IMG_2066.jpg</span>
                        </div>
                        <!-- Image 2 Placeholder -->
                        <div class="border border-stone-200 rounded-lg p-2 bg-stone-50 text-center">
                            <div class="aspect-[3/4] bg-stone-200 rounded flex items-center justify-center mb-2 overflow-hidden">
                                <!-- Replace src with actual path if files are local, e.g. "IMG_2067.jpg" -->
                                <img src="IMG_2067.jpg" alt="é›»å­å…¥å¢ƒå¡ 2" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/300x400/e5e5e5/a3a3a3?text=IMG_2067.jpg';">
                            </div>
                            <span class="text-xs text-stone-500">IMG_2067.jpg</span>
                        </div>
                    </div>
                </div>

                <!-- 5. Emergency Info -->
                <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                    <h3 class="text-red-800 font-bold mb-3 flex items-center">
                        <i class="fa-solid fa-kit-medical mr-2"></i> ç·Šæ€¥è¯çµ¡ (åƒ…ä¾›æŸ¥é–±)
                    </h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-red-100 pb-2">
                            <span class="text-sm text-stone-600">è­¦å¯Ÿ / æ•‘è­·è»Š</span>
                            <span class="font-mono text-lg font-bold text-red-600">112 / 119</span>
                        </div>
                        <div class="flex justify-between items-center border-b border-red-100 pb-2">
                            <span class="text-sm text-stone-600">å¤–äº¤éƒ¨ç·Šæ€¥è¯çµ¡</span>
                            <span class="font-mono text-sm font-bold text-stone-700">+82-10-9093-5009</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-stone-600">Seoul N Hostel æ—…é¤¨é›»è©±</span>
                            <span class="font-mono text-sm font-bold text-stone-700">070-8152-8160</span>
                        </div>
                    </div>
                </div>

                <!-- 6. Tips (Bottom) -->
                <div class="bg-stone-800 text-stone-300 p-5 rounded-xl">
                    <h3 class="text-white font-serif mb-3"><i class="fa-solid fa-triangle-exclamation mr-2 text-amber-500"></i>æ³¨æ„äº‹é … & ç¦å¿Œ</h3>
                    <ul class="text-sm space-y-2 list-disc list-inside">
                        <li><strong class="text-white">é•ç¦å“ï¼š</strong>è‚‰é¡è£½å“(å«è‚‰ä¹¾ã€é¦™è…¸)åš´ç¦æ”œå¸¶å…¥å¢ƒï¼Œé•è€…é‡ç½°ã€‚æ–°é®®æ°´æœäº¦ä¸å¯å…¥å¢ƒã€‚</li>
                        <li><strong class="text-white">é›»å£“ï¼š</strong>220Vï¼Œå…©å­”åœ“å½¢æ’åº§ (éœ€è½‰æ¥é ­)ã€‚</li>
                        <li><strong class="text-white">ç¦®å„€ï¼š</strong>æ­ä¹˜åœ°éµè«‹å‹¿ååšæ„›åº§ã€‚é¤å»³å°èœå¯å…è²»çºŒåŠ ï¼Œä½†è«‹ä»¥æ­¤ç‚ºé™ï¼Œå‹¿æµªè²»ã€‚</li>
                        <li><strong class="text-white">äº¤é€šï¼š</strong>Google Maps åƒ…ä¾›æŸ¥è©¢å¤§çœ¾é‹è¼¸ï¼Œæ­¥è¡Œå°èˆªå»ºè­°ä½¿ç”¨ NAVER Mapã€‚</li>
                    </ul>
                </div>
                
                <div class="text-center pt-8">
                    <button onclick="resetApp()" class="text-xs text-stone-300 underline">é‡ç½®æ‰€æœ‰è³‡æ–™ (Reset)</button>
                </div>
            </div>
        </div>

    </main>
    
    <!-- DETAIL MODAL (Pop-up) -->
    <div id="detail-modal-overlay" class="modal-overlay" onclick="closeDetailModal(event)">
        <div id="detail-modal-content" class="modal-content" onclick="event.stopPropagation()">
            <div class="sticky top-0 bg-muji-bg px-6 py-4 border-b border-stone-200 flex justify-between items-center z-20">
                <h2 id="modal-title" class="font-serif text-2xl text-stone-800 truncate pr-4"></h2>
                <button onclick="closeDetailModal()" class="text-stone-400 hover:text-stone-800 transition">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div id="modal-body" class="p-6 space-y-6 pb-12">
                <!-- Content will be injected here by JS -->
                
                <!-- Time Label -->
                <div class="flex items-center gap-2">
                    <span class="bg-stone-200 text-stone-700 px-3 py-1 rounded-full text-xs font-mono font-bold" id="modal-time"></span>
                </div>
                
                <!-- Story Section -->
                <div id="modal-section-story">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-stone-400 pl-2">æ™¯é»æ•…äº‹</h3>
                    <p id="modal-story" class="text-sm text-stone-600 leading-relaxed text-justify"></p>
                </div>

                <!-- Guide Section -->
                <div id="modal-section-guide">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-stone-400 pl-2">æ—…éŠæ”»ç•¥</h3>
                    <p id="modal-guide" class="text-sm text-stone-600 leading-relaxed text-justify"></p>
                </div>
                
                <!-- Tips Section -->
                <div id="modal-tips-container">
                    <h3 class="font-serif text-lg mb-2 text-stone-800 border-l-4 border-muji-highlight pl-2">é‡é»æé†’</h3>
                    <div id="modal-tips" class="space-y-3">
                        <!-- Tips injected here -->
                    </div>
                </div>

                <!-- Map Button -->
                <div class="pt-4 border-t border-stone-100">
                    <a id="modal-map-link" href="#" target="_blank" class="block w-full text-center bg-stone-800 text-white py-3 rounded-lg shadow-md active:scale-95 transition text-sm font-medium tracking-wide">
                        <i class="fa-solid fa-map-location-dot mr-1"></i> åœ¨åœ°åœ–ä¸ŠæŸ¥çœ‹
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-stone-200 px-6 py-2 pb-5 flex justify-between items-center fixed bottom-0 w-full z-50 text-xs font-medium text-stone-400 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 w-12 text-muji-primary transition-colors" data-target="section-plan">
            <i class="fa-regular fa-calendar-days text-xl mb-0.5"></i>
            PLAN
        </button>
        <!-- GUIDE button removed -->
        <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-wallet">
            <i class="fa-solid fa-wallet text-xl mb-0.5"></i>
            WALLET
        </button>
        <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-lists">
            <i class="fa-solid fa-list-check text-xl mb-0.5"></i>
            LISTS
        </button>
        <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 w-12 hover:text-stone-600 transition-colors" data-target="section-info">
            <i class="fa-solid fa-circle-info text-xl mb-0.5"></i>
            INFO
        </button>
    </nav>

    <!-- Scripts -->
    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered'))
                    .catch(err => console.log('Service Worker Error', err));
            });
        }

        // --- Data & State ---
        // é¡åˆ¥é¡è‰²æ˜ å°„
        const categoryMap = {
            'Attraction': { name: 'æ™¯é»', color: 'bg-attraction', icon: 'fa-archway' },
            'Restaurant': { name: 'é¤å»³', color: 'bg-restaurant', icon: 'fa-utensils' },
            'Shopping': { name: 'é€›è¡—', color: 'bg-shopping', icon: 'fa-bag-shopping' },
            'Transport': { name: 'äº¤é€š', color: 'bg-transport', icon: 'fa-bus' },
            'Accommodation': { name: 'ä½å®¿', color: 'bg-indigo-400', icon: 'fa-bed' },
            'Other': { name: 'å…¶ä»–', color: 'bg-stone-400', icon: 'fa-circle' }
        };

        // æ—…éŠè¡Œç¨‹è³‡æ–™
        const itineraryData = [
            {
                date: "12/18", day: "Day 1",
                events: [
                    { time: "18:15", title: "æŠµé”ä»å·æ©Ÿå ´", desc: "é™è½ï¼Œæº–å‚™å…¥å¢ƒ", icon: "fa-plane-arrival" },
                    { 
                        time: "19:00", 
                        title: "å‰å¾€å¸‚å€", 
                        desc: "é¸æ“‡ä¸€ï¼šæ©Ÿå ´å·´å£«(6001ç·š) ç´„1.5å°æ™‚ï¼Œ17,000éŸ“å…ƒ/äºº\né¸æ“‡äºŒï¼šåŒ…è»Š/æ±½è»Š ç´„1å°æ™‚15åˆ†ï¼Œ600å°å¹£/äºº", 
                        highlight: true, 
                        icon: "fa-bus", 
                        link: "https://maps.app.goo.gl/xuu6swMwXezqVpUk6",
                        details: {
                            story: "6001è™Ÿæ©Ÿå ´å·´å£«æ˜¯å‰å¾€æ±å¤§é–€ã€æ˜æ´åœ°å€æœ€æ–¹ä¾¿çš„é¸æ“‡ä¹‹ä¸€ï¼Œåƒ¹æ ¼å¯¦æƒ ä¸”ä¸å¿…è½‰è»Šã€‚å†¬å­£æ™‚ï¼Œå‹™å¿…åœ¨å€™è»Šäº­å…§ç­‰å€™ï¼Œé¿å…å—å¯’ã€‚",
                            guide: "å¾ä»å·æ©Ÿå ´å…¥å¢ƒå¤§å»³å‡ºä¾†å¾Œï¼ŒæŒ‰ç…§æŒ‡ç¤ºç‰Œæ‰¾åˆ°6001è™Ÿå·´å£«ç«™ç‰Œã€‚ä¸Šè»Šå¾Œè¨˜å¾—ä½¿ç”¨ T-Money å¡æˆ–è³¼è²·è»Šç¥¨ã€‚",
                            tips: [
                                { type: "é‡è¦æé†’", text: "å·´å£«è»Šç¥¨ç´„ 17,000 KRWï¼Œæº–å‚™å¥½ç¾é‡‘æˆ–ç¢ºä¿ T-Money é¤˜é¡å……è¶³ã€‚" }
                            ]
                        }
                    },
                    { time: "20:30", title: "Check-in", desc: "Seoul N Hostel", icon: "fa-bed", link: "https://maps.app.goo.gl/xuu6swMwXezqVpUk6" },
                    { 
                        time: "21:00", 
                        title: "æ™šé¤ï¼šçƒ¤è‚‰", 
                        desc: "é¸é …å¦‚ä¸‹ (é»æ“Šå°èˆª)ï¼š", 
                        icon: "fa-utensils", 
                        subItems: [
                            { name: "è‚‰å…¸é£Ÿå ‚", query: "https://maps.app.goo.gl/AwpU7SAtDeqDkPC49" },
                            { name: "äº”èŠ±è‚‰å¤§ç¸½çµ±", query: "https://maps.app.goo.gl/T5AxezQenBJoT6Hp7" }
                        ],
                        details: {
                            story: "é¦–çˆ¾çš„çƒ¤è‚‰æ–‡åŒ–ä¸å¯éŒ¯éã€‚è‚‰å…¸é£Ÿå ‚ä»¥åšåˆ‡äº”èŠ±è‚‰èˆ‡å°ˆäººä»£çƒ¤èåï¼›äº”èŠ±è‚‰å¤§ç¸½çµ±å‰‡ä»¥ç«¹ç­’ç†Ÿæˆäº”èŠ±è‚‰ç‚ºç‰¹è‰²ã€‚",
                            guide: "å…©å®¶éƒ½æ˜¯æ±å¤§é–€/æ–°è¨­æ´é™„è¿‘çš„äººæ°£ååº—ï¼Œå»ºè­°é¿é–‹æ­£é¤å°–å³°æ™‚é–“ä»¥å…ä¹…å€™ã€‚",
                            tips: [
                                { type: "å¿…é»èœå–®", text: "åšåˆ‡äº”èŠ±è‚‰ã€ç«¹ç­’äº”èŠ±è‚‰ã€‚" },
                                { type: "å¿…åƒç¾é£Ÿ", text: "æ­é…å¤§é†¬æ¹¯æˆ–å†·éºµè§£è†©ã€‚" }
                            ]
                        }
                    },
                    { time: "22:30", title: "å®µå¤œï¼šBHC ç‚¸é›", desc: "ï¼‹é€›é€›é™„è¿‘è¡£æœæ‰¹ç™¼ç››æ³", icon: "fa-drumstick-bite", link: "https://maps.app.goo.gl/GCE9XvyhQftPSuMF6" }
                ]
            },
            {
                date: "12/19", day: "Day 2",
                events: [
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "2014è™Ÿå·´å£« 12åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FUQxbA0l" 
                    },
                    { 
                        time: "08:30", 
                        title: "å»£è—å¸‚å ´", 
                        desc: "ç³¯ç±³éº»èŠ±æ²ã€ç¶ è±†ç…é¤…ã€ç´«èœé£¯æ²ã€å†·è•éº¥éºµ", 
                        icon: "fa-store", 
                        link: "Gwangjang Market",
                        details: {
                            story: "å»£è—å¸‚å ´æ˜¯éŸ“åœ‹æ­·å²æœ€æ‚ ä¹…çš„å‚³çµ±å¸‚å ´ï¼Œèµ·æºæ–¼1905å¹´ã€‚å®ƒç¾åœ¨å·²æˆç‚ºé¦–çˆ¾æœ€å…·ä»£è¡¨æ€§çš„ç¾é£Ÿå¤©å ‚ï¼Œä¿ç•™äº†å‚³çµ±å¸‚é›†çš„å–§å›‚å’Œäººæƒ…å‘³ã€‚",
                            guide: "å¸‚å ´ä¸»è¦åˆ†ç‚ºç¾é£Ÿå€å’Œå¸ƒæ–™å€ã€‚å»ºè­°åœ¨æ—©ä¸Šå‰å¾€ï¼Œé¿é–‹æ™šé¤é«˜å³°ã€‚",
                            tips: [
                                { type: "å¿…åƒç¾é£Ÿ", text: "ç¶ è±†ç…é¤… (Bindae-tteok)ã€‚" },
                                { type: "å¿…é»èœå–®", text: "éº»è—¥é£¯æ² (Mayak Gimbap)ã€‚" }
                            ]
                        } 
                    },
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "å·´å£« 30åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FnVHdQGL" 
                    },
                    { time: "11:00", title: "åŒ—æ‘éŸ“å±‹æ‘ / ä¸‰æ¸…æ´", desc: "å«ä¸‰æ¸…æ´å£ç•«è¡—æ•£ç­–", icon: "fa-camera", link: "Bukchon Hanok Village" },
                    { 
                        time: "12:00", 
                        title: "ç¾å‘³åˆé¤", 
                        desc: "é¸é …å¦‚ä¸‹ (é»æ“Šå°èˆª)ï¼š", 
                        icon: "fa-utensils",
                        subItems: [
                            { name: "ä¸‰æ¸…æ´æ‘©è¥¿å¹´ç³•é‹", query: "https://maps.app.goo.gl/VzuKUJ2dFFSvtM25A" },
                            { name: "ä¸‰æ¸…æ´ç‰›è‚‰æ¹¯", query: "https://maps.app.goo.gl/5AZpq3AuQq7nPqBt7" }, 
                            { name: "é»ƒç”Ÿå®¶åˆ€åˆ‡éºµ", query: "https://maps.app.goo.gl/Yo49wwxWHxUG54Ra8" }
                        ]
                    },
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "é˜è·¯11è™Ÿå·´å£« 30åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/5V81ifdD"
                    },
                    { 
                        time: "14:30", 
                        title: "å—å¤§é–€å¸‚å ´", 
                        desc: "æ‰¹ç™¼/ç«¥è£", 
                        icon: "fa-bag-shopping",
                        subItems: [
                            { name: "å¡æ¢…è°·æ‰‹å·¥ç‹åŒ…å­", query: "https://maps.app.goo.gl/91Jaf4Q5iC7VGjuH9" },
                            { name: "Plan B: é¦–çˆ¾ç«™æ¨‚å¤©Outlet", query: "Lotte Outlets Seoul Station" }
                        ]
                    },
                    { // Bus Segment
                        time: "Travel", 
                        title: "ç§»å‹• (å·´å£«)", 
                        desc: "406, 401, 505å·´å£« 10åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/xslXSsTO" 
                    },
                    { // Walk Segment
                        time: "Travel", 
                        title: "ç§»å‹• (æ­¥è¡Œ)", 
                        desc: "èµ°è·¯ 15åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/Ig45dKD6" 
                    },
                    { 
                        time: "16:00", 
                        title: "N é¦–çˆ¾å¡”", 
                        desc: "æ­çºœè»Šé›»æ¢¯ (æ—¥è½ 17:20)\næ˜æ´æ­05æˆ–03å¾ªç’°å·´å£«ç›´é”å±±é ‚", 
                        icon: "fa-tower-broadcast", 
                        link: "N Seoul Tower",
                        details: {
                            story: "N é¦–çˆ¾å¡”ä½æ–¼å—å±±é ‚ï¼Œæ˜¯é¦–çˆ¾çš„åœ°æ¨™æ€§å»ºç¯‰ã€‚å¡”ä¸Šçš„æ•¸ä½è§€æ™¯å°æä¾›360åº¦å…¨æ™¯è¦–é‡ï¼Œå†¬å­£å¤œæ™šæ™¯è‰²å°¤å…¶å£¯è§€ã€‚è‘—åçš„æ„›æƒ…é–ç‰†ä¹Ÿåœ¨æ­¤è™•ã€‚",
                            guide: "å¯ä»¥åˆ°çºœè»Šé›»æ¢¯ç›´ä¸Šçºœè»Šæ­ä¹˜è™•ã€‚ä¸Šå±±æœ‰å¤šç¨®æ–¹å¼ï¼šçºœè»Šã€å¾ªç’°å·´å£«ï¼ˆ02, 03, 05è™Ÿï¼‰ã€‚å¾ªç’°å·´å£«æœ€ç‚ºç¶“æ¿Ÿä¸”ç›´æ¥åˆ°é”ï¼Œä½†å¦‚æœæƒ³é«”é©—çºœè»Šæµªæ¼«ï¼Œå‰‡éœ€å¾æ˜æ´ç«™æ­¥è¡Œè‡³çºœè»Šç«™ã€‚",
                            tips: [
                                { type: "é‡è¦é ç´„ä»£è™Ÿ", text: "å¦‚æœé¸æ“‡çºœè»Šï¼Œå»ºè­°æå‰åœ¨ç·šä¸Šè¨‚ç¥¨ï¼Œç¯€çœæ’éšŠæ™‚é–“ã€‚" },
                                { type: "å¿…è²·ä¼´æ‰‹ç¦®", text: "åœ¨å±±ä¸‹æˆ–å¡”é ‚çš„ç´€å¿µå“åº—è³¼è²·ä¸€å€‹æ„›æƒ…é–æ›ä¸Šå»ã€‚" }
                            ]
                        } 
                    },
                    { // New Link for Cable Car Elevator
                        time: "Travel", 
                        title: "çºœè»Šé›»æ¢¯", 
                        desc: "å‰å¾€æ­ä¹˜è™•", 
                        isTravel: true,
                        linkUrl: "https://maps.app.goo.gl/vMcPPfzL3UnDCUZ5A"
                    },
                    { // Bus Segment (New)
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "406, 401, 143 å·´å£« 15åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/5OtHHlQ4" 
                    },
                    { 
                        time: "19:00", 
                        title: "æ˜æ´å•†åœˆ & æ™šé¤", 
                        desc: "æ˜æ´æ–°ä¸–ç•Œç™¾è²¨", 
                        icon: "fa-shop",
                        subItems: [
                            { name: "ç³–è‘«è˜†å°å“¥ (Noon Squareå‰)", query: "Noon Square" },
                            { name: "ç¥ä»™é›ªæ¿ƒæ¹¯", query: "Sinseon Seolnongtang Myeongdong" },
                            { name: "å‘³æˆå±‹é›ªæ¿ƒæ¹¯", query: "Miseongok" }
                        ],
                        details: {
                            story: "æ˜æ´æ˜¯é¦–çˆ¾æœ€å—æ­¡è¿çš„è³¼ç‰©å€ä¹‹ä¸€ï¼Œä½†è¿‘å¹´ä¾†å·²è½‰è®Šç‚ºåœ‹éš›åŒ–è§€å…‰å€ï¼Œå……æ»¿äº†ç¾å¦åº—ã€æœé£¾åº—å’Œè¡—é ­å°åƒã€‚æ¯å¹´åº•çš„æ–°ä¸–ç•Œç™¾è²¨è–èª•ç‡ˆé£¾æ˜¯å¿…çœ‹æ™¯é»ã€‚",
                            guide: "æ™šé¤æ¨è–¦å“åšä¸€ç¢—ç†±é¨°é¨°çš„é›ªæ¿ƒæ¹¯ï¼Œç‰¹åˆ¥æ˜¯åœ¨å¯’å†·çš„å†¬å¤©ã€‚è¡—é ­å°åƒå‰‡æ¨è–¦é­šæ¿ä¸²ã€çƒ¤è…¸ç­‰ã€‚",
                            tips: [
                                { type: "å¿…åƒç¾é£Ÿ", text: "è¡—é‚Šçš„ç¾çƒ¤ç³–é¤…æˆ–è‰è“ç³–è‘«è˜†ã€‚" }
                            ]
                        }
                    }
                ]
            },
            {
                date: "12/20", day: "Day 3",
                events: [
                    { time: "07:30", title: "æ™¨è·‘", desc: "é§±å±±å…¬åœ’ (å–®ç¨‹2.1kmä¸Šå¡)ã€æ¢¨èŠ±æ´å£ç•«æ‘", icon: "fa-person-running", link: "Naksan Park" },
                    { 
                        time: "10:00", 
                        title: "æ±å¤§é–€æ—©åˆé¤", 
                        desc: "ç¾å‘³éŸ“é£Ÿ", 
                        icon: "fa-bowl-food",
                        subItems: [
                            { name: "é¦™æ¸¯é£¯åº—0410PLUS", query: "Hong Kong Banjeom 0410 Dongdaemun" },
                            { name: "æµ·è‹”é£¯æ²", query: "https://maps.app.goo.gl/VkmVHP1PaFgTTojW6" }
                        ]
                    },
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "åœ°éµ 20åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/xnro2gSz"
                    },
                    { // --- MODIFIED: ADDED 'ç«™' ---
                        time: "12:00", 
                        title: "ç‹é·—äº­ç¾…å¾·å¥§ç«™", 
                        desc: "é€›é€›è¡Œç¨‹", 
                        icon: "fa-bag-shopping",
                        subItems: [
                            { name: "Jayeondo é¹½éºµåŒ…", query: "Jayeondo Sogeumppang Apgujeong" },
                            { name: "HDEX HYM DOSAN", query: "HDEX HYM DOSAN" }
                        ],
                        details: {
                            story: "ç‹é·—äº­ç¾…å¾·å¥§æ˜¯é¦–çˆ¾æ±Ÿå—å€æ™‚å°šèˆ‡å¥¢è¯çš„ä»£åè©ï¼Œèšé›†äº†è¨±å¤šè¨­è¨ˆå¸«å“ç‰Œã€æ——è‰¦åº—å’Œé«˜æª”å’–å•¡å»³ï¼Œæ˜¯é«”é©—é¦–çˆ¾K-Popæ–‡åŒ–å’Œæ½®æµçš„çµ•ä½³åœ°é»ã€‚",
                            guide: "é€™å€çš„å’–å•¡å»³å¾ˆå¤šéƒ½æ˜¯ç¨æ£Ÿè¨­è¨ˆï¼Œç’°å¢ƒå„ªç¾ã€‚HDEX HYM DOSANæ˜¯é‹å‹•æ½®æµå“ç‰Œï¼Œè‹¥æœ‰èˆˆè¶£å¯å‰å¾€åƒè§€ã€‚",
                            tips: [
                                { type: "å¿…åƒç¾é£Ÿ", text: "Jayeondo Sogeumppang çš„æ‹›ç‰Œé¹½éºµåŒ…ï¼Œå£æ„Ÿé…¥è„†å…§éƒ¨é¬†è»Ÿã€‚" }
                            ]
                        }
                    },
                    { 
                        time: "13:00", 
                        title: "é†«ç¾è¡Œç¨‹", 
                        desc: "V-moment", 
                        highlight: true, 
                        icon: "fa-sparkles", 
                        link: "https://maps.app.goo.gl/xmni7wxBmHpTjxH48"
                        // Details removed as requested
                    },
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "å·´å£« 20åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/GmtvjJbO"
                    },
                    { 
                        time: "16:00", 
                        title: "æ˜Ÿç©ºåœ–æ›¸é¤¨", 
                        desc: "@ Coex Mall", 
                        icon: "fa-book-open", 
                        link: "Starfield Library",
                        details: {
                            story: "æ˜Ÿç©ºåœ–æ›¸é¤¨ä½æ–¼ COEX Mall ä¸­å¿ƒï¼Œæ˜¯é¦–çˆ¾çš„æ‰“å¡ç†±é»ï¼Œä»¥å…¶é«˜é”13å…¬å°ºçš„å·¨å¤§æ›¸æ¶å’Œé–‹æ”¾å¼è¨­è¨ˆè‘—ç¨±ã€‚å¤œæ™šçš„ç‡ˆå…‰æ•ˆæœéå¸¸å£¯è§€ã€‚",
                            guide: "åœ°éµè‡³ã€Œä¸‰æˆç«™ã€ï¼Œ5ã€6è™Ÿå‡ºå£é€²å…¥ï¼Œåœ–æ›¸é¤¨å…§åº§ä½æœ‰é™ï¼Œä¸»è¦ä»¥æ‹ç…§å’Œä¼‘æ†©ç‚ºä¸»ã€‚",
                            tips: [
                                { type: "é‡è¦æé†’", text: "æœ€ä½³æ‹æ”æ™‚é–“ç‚ºå‚æ™šï¼Œç‡ˆå…‰å…¨é–‹æ™‚ã€‚" }
                            ]
                        }
                    },
                    { 
                        time: "Travel", 
                        title: "ç§»å‹•", 
                        desc: "åœ°éµ 50åˆ†é˜", 
                        isTravel: true,
                        linkUrl: "https://naver.me/FlcwoRT4"
                    },
                    { time: "18:00", title: "è–èª•æ°›åœ", desc: "å…‰åŒ–é–€è–èª•å¸‚é›†ã€æ¸…æºªå·ç‡ˆç¯€ (å…­æ—¥18:00~22:00)", icon: "fa-tree", link: "Gwanghwamun Square" }
                ]
            },
            {
                date: "12/21", day: "Day 4",
                events: [
                    { time: "07:30", title: "å‰å¾€æ©Ÿå ´", desc: "æ­ä¹˜ 6001 è™Ÿæ©Ÿå ´å·´å£«", highlight: true, icon: "fa-bus", category: "Transport" },
                    { time: "11:50", title: "é£›æ©Ÿèµ·é£›", desc: "RF5193 (ICN-HUN)", icon: "fa-plane-departure", category: "Transport" },
                    { time: "13:30", title: "æŠµé”æº«æš–çš„å®¶", desc: "å¹³å®‰æ­¸ä¾†æº«æš–çš„å®¶", icon: "fa-house", category: "Other" }
                ]
            }
        ];

        // --- FIXED: Define defaultChecklist here ---
        const defaultChecklist = [
            { text: "éŸ“åœ‹ç·šä¸Šå…¥å¢ƒå¡ (Q-Code)", checked: false },
            { text: "Esim / ç¶²å¡", checked: false },
            { text: "è½‰æ¥é ­ (åœ“å­”)", checked: false },
            { text: "T-money æ‚ éŠå¡", checked: false },
            { text: "è­·ç…§", checked: false },
            { text: "ç¾é‡‘", checked: false },
            { text: "è¡Œå‹•é›»æº", checked: false }
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPlanTabs();
            renderPlanContent(0);
            initWallet();
            initLists();
            
            // Calculator Input Listener
            document.getElementById('calc-input').addEventListener('input', calculateTotal);
            
            // Setup Tab Style Logic
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    navBtns.forEach(b => {
                        b.classList.remove('text-muji-primary');
                        b.classList.add('text-stone-400');
                    });
                    this.classList.remove('text-stone-400');
                    this.classList.add('text-muji-primary');
                });
            });
        });

        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(`section-${tabId}`).classList.add('active');
            document.getElementById('main-container').scrollTo({
                top: 0,
                behavior: 'smooth'
        });

        // --- PLAN Section Logic (Updated to Card View) ---
        function renderPlanTabs() {
            const container = document.getElementById('day-tabs');
            container.innerHTML = itineraryData.map((day, index) => `
                <button onclick="renderPlanContent(${index})" 
                    class="day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all ${index === 0 ? 'bg-stone-800 text-white shadow-md' : 'bg-white text-stone-500 border border-stone-200'}" 
                    data-index="${index}">
                    <span class="block text-xs opacity-70">${day.date}</span>
                    <span>${day.day}</span>
                </button>
            `).join('');
        }

        function renderPlanContent(dayIndex) {
            // Update Tab Styles
            document.querySelectorAll('.day-tab-btn').forEach(btn => {
                if (parseInt(btn.dataset.index) === dayIndex) {
                    btn.className = "day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all bg-stone-800 text-white shadow-md transform scale-105";
                } else {
                    btn.className = "day-tab-btn flex-shrink-0 px-5 py-2 rounded-full text-sm font-medium transition-all bg-white text-stone-500 border border-stone-200";
                }
            });

            // Render Cards
            const day = itineraryData[dayIndex];
            const container = document.getElementById('itinerary-content');
            
            let html = '';
            day.events.forEach((event, index) => {
                const timeColor = event.highlight ? 'text-muji-highlight' : 'text-muji-primary';
                
                // Travel Card - Simplified
                if (event.isTravel) {
                    let travelContent = `<span class="text-stone-500">${event.desc}</span>`;
                    if (event.linkUrl) {
                        travelContent += ` <a href="${event.linkUrl}" target="_blank" class="ml-1 text-muji-highlight underline"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>`;
                    }
                    html += `
                        <div class="flex items-center gap-4 bg-stone-100 p-3 rounded-xl border border-stone-200">
                            <i class="fa-solid fa-route text-2xl text-stone-400 min-w-[30px] text-center"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-stone-700">${event.title}</h4>
                                <div class="text-xs text-stone-500 font-mono">${travelContent}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sub Items (Buttons)
                    let linkBtn = '';
                    if (event.link) {
                        // Check if link is URL or Query
                        const href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                        linkBtn = `
                            <a href="${href}" target="_blank" 
                               onclick="event.stopPropagation()"
                               class="inline-block mt-2 text-xs bg-stone-100 text-stone-600 px-3 py-1.5 rounded-md hover:bg-stone-200">
                               <i class="fa-solid fa-map-location-dot mr-1"></i> åœ°åœ–
                            </a>
                        `;
                    }
                    if (event.subItems) {
                        linkBtn = `<div class="mt-3 flex flex-wrap gap-2">`;
                        event.subItems.forEach(item => {
                            // Check if item query is a URL or search query
                            const itemHref = item.query.startsWith('http') ? item.query : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.query)}`;
                            linkBtn += `
                                <a href="${itemHref}" target="_blank" 
                                   onclick="event.stopPropagation()"
                                   class="inline-block text-xs border border-stone-200 text-stone-600 px-3 py-1.5 rounded-md hover:bg-stone-50 hover:border-stone-300">
                                   <i class="fa-solid fa-location-dot mr-1 text-stone-400"></i> ${item.name}
                                </a>
                            `;
                        });
                        linkBtn += `</div>`;
                    }

                    // Standard Clickable Card
                    html += `
                        <div onclick="openDetailModal(${dayIndex}, ${index})"
                             class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 cursor-pointer active:scale-[0.99] transition-transform">
                            <div class="flex justify-between items-start">
                                <div class="flex flex-col">
                                    <span class="text-sm ${timeColor} font-mono">${event.time}</span>
                                    <h4 class="font-bold text-lg text-stone-800 mt-0.5">${event.title}</h4>
                                </div>
                                <i class="fa-solid ${event.icon} text-2xl text-stone-300"></i>
                            </div>
                            <p class="text-sm text-muji-sub mt-2">${event.desc.replace(/\n/g, '<br>')}</p>
                            ${linkBtn}
                        </div>
                    `;
                }
            });
            container.innerHTML = html;
        }

        function openDetailModal(dayIndex, eventIndex) {
            const event = itineraryData[dayIndex].events[eventIndex];
            const modalOverlay = document.getElementById('detail-modal-overlay');
            
            // Check if details exist
            if (!event.details) {
                // If no details, just open the map link or show a simplified view
                if (event.link) {
                    const href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                    window.open(href, '_blank');
                    return;
                }
                // Fallback to simple description if no map link either
                alert(`[${event.time}] ${event.title}\n\n${event.desc}\n\næ­¤è¡Œç¨‹ç„¡è©³ç´°æ”»ç•¥ã€‚`);
                return;
            }

            // Set Modal Content
            document.getElementById('modal-title').innerText = event.title;
            document.getElementById('modal-time').innerText = event.time;
            document.getElementById('modal-story').innerText = event.details.story || "æš«ç„¡è©³ç´°æ•…äº‹";
            document.getElementById('modal-guide').innerText = event.details.guide || "æš«ç„¡è©³ç´°æ”»ç•¥";
            
            // Map Link
            const mapLink = document.getElementById('modal-map-link');
            if (event.link) {
                mapLink.href = event.link.startsWith('http') ? event.link : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.link)}`;
                mapLink.style.display = 'block';
            } else {
                mapLink.style.display = 'none';
            }
            
            // Tips Rendering
            const tipsContainer = document.getElementById('modal-tips');
            let tipsHtml = '';
            
            const tipColorMap = {
                'å¿…åƒç¾é£Ÿ': 'bg-red-100 text-red-700 border-red-200',
                'å¿…é»èœå–®': 'bg-green-100 text-green-700 border-green-200',
                'å¿…è²·ä¼´æ‰‹ç¦®': 'bg-blue-100 text-blue-700 border-blue-200',
                'é‡è¦é ç´„ä»£è™Ÿ': 'bg-yellow-100 text-yellow-700 border-yellow-200',
                'é‡è¦æé†’': 'bg-yellow-100 text-yellow-700 border-yellow-200'
            };

            if (event.details.tips && event.details.tips.length > 0) {
                event.details.tips.forEach(tip => {
                    const tipClass = tipColorMap[tip.type] || 'bg-stone-100 text-stone-700 border-stone-200';
                    tipsHtml += `
                        <div class="p-3 rounded-lg border ${tipClass}">
                            <strong class="text-sm font-bold block mb-1">${tip.type}</strong>
                            <p class="text-sm">${tip.text}</p>
                        </div>
                    `;
                });
                document.getElementById('modal-tips-container').style.display = 'block';
            } else {
                document.getElementById('modal-tips-container').style.display = 'none';
            }
            tipsContainer.innerHTML = tipsHtml;

            // Show Modal
            modalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeDetailModal(event) {
            const modalOverlay = document.getElementById('detail-modal-overlay');
            if (event && event.target !== modalOverlay) return; // Only close if clicking overlay

            modalOverlay.classList.remove('active');
            document.body.style.overflow = ''; // Restore background scrolling
        }


        // --- WALLET Section Logic ---
        let expenseChart = null; // Global variable for chart instance

        function initWallet() {
            // Rate
            const savedRate = localStorage.getItem('krw_rate');
            if (savedRate) document.getElementById('exchange-rate').value = savedRate;
            
            // Expenses
            renderExpenseList();
        }

        function updateRate() {
            const rate = document.getElementById('exchange-rate').value;
            localStorage.setItem('krw_rate', rate);
            renderExpenseList(); // Update totals in list
            calculateTotal(); // Update calculator
            renderChart(); // Update chart
        }

        function calculateTotal() {
            const input = document.getElementById('calc-input').value;
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42; 
            
            if (/^[0-9+\-*/.() ]*$/.test(input) && input.trim() !== "") {
                try {
                    const result = new Function('return ' + input)();
                    if (isFinite(result)) {
                        document.getElementById('calc-result-krw').innerText = Math.round(result).toLocaleString() + " â‚©";
                        const twd = Math.round(result / rate);
                        document.getElementById('calc-result-twd').innerText = "NT$ " + twd.toLocaleString();
                        return result;
                    }
                } catch (e) {}
            }
            
            if(input.trim() === "") {
                document.getElementById('calc-result-krw').innerText = "0 â‚©";
                document.getElementById('calc-result-twd').innerText = "0 NT$";
            }
            return 0;
        }

        function copyCalcToExpense() {
            const result = calculateTotal();
            if (result > 0) {
                document.getElementById('expense-amount').value = Math.round(result);
                document.getElementById('expense-name').focus();
            }
        }

        function addExpense() {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const payer = document.getElementById('expense-payer').value;
            const category = document.getElementById('expense-category').value;
            
            if (!name || isNaN(amount)) return;

            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.unshift({
                id: Date.now(),
                name: name,
                amount: amount,
                payer: payer,
                category: category,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            // Reset form
            document.getElementById('expense-name').value = '';
            document.getElementById('expense-amount').value = '';
            
            renderExpenseList();
            if(!document.getElementById('wallet-view-chart').classList.contains('hidden')) {
                renderChart();
            }
        }

        function deleteExpense(id) {
            let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenseList();
            if(!document.getElementById('wallet-view-chart').classList.contains('hidden')) {
                renderChart();
            }
        }

        function toggleWalletView(view) {
            const listBtn = document.getElementById('btn-view-list');
            const chartBtn = document.getElementById('btn-view-chart');
            const listView = document.getElementById('wallet-view-list');
            const chartView = document.getElementById('wallet-view-chart');

            if (view === 'list') {
                listBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
                listBtn.classList.remove('text-stone-500');
                chartBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
                chartBtn.classList.add('text-stone-500');
                listView.classList.remove('hidden');
                chartView.classList.add('hidden');
            } else {
                chartBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
                chartBtn.classList.remove('text-stone-500');
                listBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
                listBtn.classList.add('text-stone-500');
                listView.classList.add('hidden');
                chartView.classList.remove('hidden');
                renderChart();
            }
        }

        function renderExpenseList() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const list = document.getElementById('expense-list');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42;
            
            let totalTWD = 0;
            let totalKathy = 0;
            let totalNick = 0;

            const categoryIcons = {
                'food': '<i class="fa-solid fa-utensils text-rose-400"></i>',
                'transport': '<i class="fa-solid fa-bus text-blue-400"></i>',
                'stay': '<i class="fa-solid fa-bed text-indigo-400"></i>',
                'other': '<i class="fa-solid fa-bag-shopping text-stone-400"></i>'
            };

            list.innerHTML = expenses.map(e => {
                const twd = Math.round(e.amount / rate);
                totalTWD += twd;
                
                // Payer logic (Backward compatibility: if no payer, assume unknown or default)
                const payer = e.payer || 'Kathy'; 
                if (payer === 'Kathy') totalKathy += twd;
                if (payer === 'Nick') totalNick += twd;

                const payerBadgeClass = payer === 'Nick' 
                    ? 'bg-stone-600 text-white' 
                    : 'bg-stone-200 text-stone-600';
                
                const catIcon = categoryIcons[e.category || 'other'];

                return `
                    <li class="bg-white p-3 rounded-lg shadow-sm border border-stone-100 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-stone-50 flex items-center justify-center text-xs">
                                ${catIcon}
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded ${payerBadgeClass}">${payer}</span>
                                    <div class="font-medium text-stone-700">${e.name}</div>
                                </div>
                                <div class="text-xs text-stone-400">${e.date}</div>
                            </div>
                        </div>
                        <div class="text-right flex items-center gap-3">
                            <div>
                                <div class="text-sm font-bold text-stone-800">â‚©${e.amount.toLocaleString()}</div>
                                <div class="text-xs text-muji-sub">â‰ˆ NT$${twd.toLocaleString()}</div>
                            </div>
                            <button onclick="deleteExpense(${e.id})" class="text-stone-300 hover:text-red-400 px-2">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                `;
            }).join('');

            document.getElementById('total-twd').innerText = `NT$ ${totalTWD.toLocaleString()}`;
            document.getElementById('total-kathy').innerText = `NT$ ${totalKathy.toLocaleString()}`;
            document.getElementById('total-nick').innerText = `NT$ ${totalNick.toLocaleString()}`;
        }

        function renderChart() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const rate = parseFloat(document.getElementById('exchange-rate').value) || 42;
            
            // Prepare Data
            const categories = {
                'food': { label: 'é£Ÿ', total: 0, color: '#f87171' }, // Red
                'transport': { label: 'äº¤é€š', total: 0, color: '#60a5fa' }, // Blue
                'stay': { label: 'ä½å®¿', total: 0, color: '#818cf8' }, // Indigo
                'other': { label: 'å…¶ä»–', total: 0, color: '#a8a29e' } // Stone
            };

            expenses.forEach(e => {
                const cat = e.category || 'other';
                categories[cat].total += Math.round(e.amount / rate);
            });

            const labels = Object.values(categories).map(c => c.label);
            const data = Object.values(categories).map(c => c.total);
            const backgroundColors = Object.values(categories).map(c => c.color);

            // Update Summary List under Chart
            const summaryList = document.getElementById('category-summary-list');
            let summaryHTML = '';
            let total = data.reduce((a, b) => a + b, 0);
            
            Object.values(categories).forEach(c => {
                const percentage = total > 0 ? Math.round((c.total / total) * 100) : 0;
                summaryHTML += `
                    <div class="flex justify-between items-center text-sm border-b border-stone-100 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full" style="background-color: ${c.color}"></span>
                            <span class="text-stone-600">${c.label}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-stone-800">NT$ ${c.total.toLocaleString()}</span>
                            <span class="text-xs text-stone-400 ml-1">(${percentage}%)</span>
                        </div>
                    </div>
                `;
            });
            summaryList.innerHTML = summaryHTML;

            // Render Chart
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (expenseChart) {
                expenseChart.destroy();
            }

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: "'Noto Sans TC', sans-serif",
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        // --- LISTS Section Logic ---
        function initLists() {
            // Checklist
            let checklist = JSON.parse(localStorage.getItem('checklist'));
            if (!checklist) {
                checklist = defaultChecklist;
                localStorage.setItem('checklist', JSON.stringify(checklist));
            }
            renderChecklist();

            // Memo
            const memo = localStorage.getItem('user_memo') || '';
            const textarea = document.getElementById('memo-area');
            textarea.value = memo;
            extractLinks(memo);

            textarea.addEventListener('input', (e) => {
                localStorage.setItem('user_memo', e.target.value);
                extractLinks(e.target.value);
            });
        }

        function toggleCheck(index) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist[index].checked = !checklist[index].checked;
            localStorage.setItem('checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function updateChecklistText(index, newText) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist[index].text = newText;
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }

        function addChecklistItem() {
            const input = document.getElementById('new-checklist-item');
            const text = input.value.trim();
            if (text) {
                const checklist = JSON.parse(localStorage.getItem('checklist')) || [];
                checklist.push({ text: text, checked: false });
                localStorage.setItem('checklist', JSON.stringify(checklist));
                input.value = ''; // Clear input
                renderChecklist();
                
                // Focus back on the new input after render
                setTimeout(() => document.getElementById('new-checklist-item').focus(), 100);
            }
        }

        function deleteChecklistItem(index) {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            checklist.splice(index, 1);
            localStorage.setItem('checklist', JSON.stringify(checklist));
            renderChecklist();
        }

        function renderChecklist() {
            const checklist = JSON.parse(localStorage.getItem('checklist'));
            const container = document.getElementById('checklist-container');
            
            container.innerHTML = checklist.map((item, index) => `
                <div class="flex items-center space-x-3 bg-white p-3 rounded-lg shadow-sm border border-stone-100 group">
                    <input type="checkbox" class="muji-checkbox w-5 h-5 flex-shrink-0 rounded border-stone-300 text-stone-600 focus:ring-stone-500" 
                        ${item.checked ? 'checked' : ''} onchange="toggleCheck(${index})">
                    
                    <input type="text" class="input-ghost text-sm text-stone-700 ${item.checked ? 'line-through opacity-50' : ''}"
                        value="${item.text}" onchange="updateChecklistText(${index}, this.value)">
                        
                    <button onclick="deleteChecklistItem(${index})" class="text-stone-300 hover:text-red-400 px-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
            `).join('');
        }

        function extractLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const matches = text.match(urlRegex);
            const container = document.getElementById('memo-links');
            
            if (matches) {
                container.innerHTML = matches.map(url => `
                    <a href="${url}" target="_blank" class="text-xs bg-stone-200 text-stone-600 px-2 py-1 rounded hover:bg-stone-300 truncate max-w-[150px] block">
                        <i class="fa-solid fa-link mr-1"></i> é€£çµ
                    </a>
                `).join('');
            } else {
                container.innerHTML = '';
            }
        }

        // --- Utils ---
        function resetApp() {
            if(confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ(è¨˜å¸³å’Œæ¸…å–®éƒ½æœƒæ¸…ç©º)')) {
                localStorage.clear();
                location.reload();
            }
        }

    </script>
</body>
</html>
